{% extends "core/base.html" %}
{% load static %}

{% block title %}Fleet Cascading Demo{% endblock %}

{% block styles %}
<style>
    .data-table { font-size: 0.85rem; }
    .results-card { margin-top: 1.5rem; }
    .table-responsive { max-height: 400px; }
    .gantt-chart-container {
        position: relative;
        width: 100%;
        height: 300px;
        border: 1px solid #ccc;
        overflow-x: auto;
        overflow-y: hidden;
        white-space: nowrap;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="h2">선단 재배치 (Fleet Cascading) 데모</h1>
    <p>주어진 선박과 신규/개편 항로 정보, 그리고 각종 비용을 바탕으로 총비용을 최소화하는 최적의 선박 재배치 계획(언제, 어떤 선박을, 어디에 투입할지)을 수립합니다.</p>

    <form method="POST">
        {% csrf_token %}
        <div class="row">
            <!-- 입력 데이터 섹션 -->
            <div class="col-lg-5">
                <div class="card">
                    <div class="card-header"><strong>1. 운영 선박 현황 (총 {{ vessels|length }}척)</strong></div>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped data-table mb-0">
                            <thead class="thead-light"><tr><th>ID</th><th>유형</th><th>계약</th><th>현재항로</th><th>가용시점(주)</th><th>상태</th></tr></thead>
                            <tbody>
                            {% for vessel in vessels %}
                                <tr {% if vessel.status == 'Dry Dock' %}class="table-danger"{% endif %}>
                                    <td>{{ vessel.id }}</td><td>{{ vessel.type }}</td><td>{{ vessel.contract }}</td>
                                    <td>{{ vessel.current_route }}</td><td>{{ vessel.available_week }}</td><td>{{ vessel.status }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-lg-7">
                <div class="card mb-3">
                    <div class="card-header"><strong>2. 개편 후 항로 요구사항</strong></div>
                    <div class="table-responsive">
                        <table class="table table-sm data-table mb-0">
                            <thead class="thead-light"><tr><th>항로 ID</th><th>필요 척수</th><th>투입 가능 유형</th><th>투입 시작(주)</th></tr></thead>
                            <tbody>
                            {% for route in routes %}
                                <tr><td>{{ route.id }}</td><td>{{ route.required_vessels }}</td><td>{{ route.acceptable_types|join:", " }}</td><td>{{ route.phase_in_week }}</td></tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                 <div class="card">
                    <div class="card-header"><strong>3. 비용 정보</strong></div>
                     <div class="table-responsive">
                        <table class="table table-sm data-table mb-0">
                            <thead class="thead-light"><tr><th>비용 항목</th><th>내용</th><th>금액 ($K)</th></tr></thead>
                            <tbody>
                                <tr><td>항로 전환 (Transition)</td><td>SHA &rarr; PUS</td><td>100</td></tr>
                                <tr><td></td><td>TYO &rarr; PUS</td><td>150</td></tr>
                                <tr><td></td><td>SIN &rarr; PUS</td><td>250</td></tr>
                                <tr><td></td><td>HKG &rarr; PUS</td><td>120</td></tr>
                                <tr><td>유휴 (Idling)</td><td>선박 1척당 1주 대기</td><td>50</td></tr>
                                <tr><td>기회 (Opportunity)</td><td>사선(Owned) 1척 투입 시</td><td>200</td></tr>
                                <tr><td>환적 (Transhipment)</td><td>유지 항로에서 선박 차출 시</td><td>300</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <button type="submit" class="btn btn-primary btn-lg mt-4">최적 재배치 계획 실행</button>
    </form>

    <!-- 결과 표시 영역 -->
    {% if error_message or success_message %}
    <hr class="my-4">
    <h3 class="mt-4">Optimization Result</h3>
    {% endif %}
    {% if error_message %}<div class="alert alert-danger">{{ error_message }}</div>{% endif %}
    {% if success_message %}<div class="alert alert-success">{{ success_message }}</div>{% endif %}

    {% if results %}
    <div class="card results-card">
        <div class="card-header"><strong>최적 재배치 결과 (Gantt Chart)</strong></div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="ganttChart"></canvas>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const resultsData = {{ results|safe|default:"{}" }};
    if (resultsData && resultsData.gantt_data) {
        const ctx = document.getElementById('ganttChart').getContext('2d');
        const ganttData = resultsData.gantt_data;

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ganttData.labels, // ['V01', 'V02', ...]
                datasets: ganttData.datasets
            },
            options: {
                indexAxis: 'y', // Y축을 기준으로 막대 표시
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, position: 'top' },
                    title: { display: true, text: '선박별 활동 스케줄 (주 단위)' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const datasetLabel = context.dataset.label || '';
                                const start = context.raw[0];
                                const end = context.raw[1];
                                return `${datasetLabel}: Week ${start} ~ ${end}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        min: 0,
                        max: 10, // 계획 기간
                        title: { display: true, text: 'Week' }
                    },
                    y: {
                        stacked: true,
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
