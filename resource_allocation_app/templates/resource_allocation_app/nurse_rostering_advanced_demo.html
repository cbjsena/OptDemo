{% extends "core/base.html" %}
{% load static %}
{% load resource_allocation_filters %}

{% block title %}Advanced Nurse Rostering Demo{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="h2">Advanced Nurse Rostering Demo</h1>
    <p>간호사별 숙련도, 휴가 요청, 시프트별 필요 인원 및 다양한 공정성 제약을 고려하여 최적 근무표를 생성합니다.</p>

    <form method="GET" class="mb-3 form-inline">
        <div class="form-group mr-2">
            <label for="num_nurses_to_show" class="mr-2">간호사 수 (5-25):</label>
            <select name="num_nurses_to_show" id="num_nurses_to_show" class="form-control form-control-sm" onchange="this.form.submit()">
                {% for i in num_nurses_options %}
                    <option value="{{ i }}" {% if i == submitted_num_nurses %}selected{% endif %}>{{ i }}명</option>
                {% endfor %}
            </select>
            <span class="text-muted ml-2 small">(변경 시 일부 정보가 초기화됩니다.)</span>
        </div>
         <noscript><button type="submit" class="btn btn-sm btn-secondary">인원 변경</button></noscript>
    </form>

    <form method="POST">
        {% csrf_token %}
        <input type="hidden" name="num_nurses" value="{{ submitted_num_nurses }}">

        <div class="row">
            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header"><strong>기본 근무 조건</strong></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="num_days">근무 기간 (일)</label>
                            <input type="number" class="form-control" id="num_days" name="num_days" value="{{ form_data.num_days|default:14 }}" min="1">
                        </div>
                        <div class="form-group">
                            <label for="min_shifts">간호사별 최소 근무일</label>
                            <input type="number" class="form-control" id="min_shifts" name="min_shifts" value="{{ form_data.min_shifts|default:5 }}" min="0">
                        </div>
                        <div class="form-group">
                            <label for="max_shifts">간호사별 최대 근무일</label>
                            <input type="number" class="form-control" id="max_shifts" name="max_shifts" value="{{ form_data.max_shifts|default:8 }}" min="0">
                        </div>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-header"><strong>공정성 목표 설정</strong></div>
                    <div class="card-body">
                        {% with submitted_fairness=form_data.getlist|get_item_simple:'fairness_options'|default_if_none:form_data.enabled_fairness %}
                        <div class="form-check"><input class="form-check-input" type="checkbox" name="fairness_options" value="fair_weekends" id="f_w" {% if 'fair_weekends' in submitted_fairness %}checked{% endif %}><label class="form-check-label" for="f_w">주말 근무 공평 분배</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" name="fairness_options" value="fair_nights" id="f_n" {% if 'fair_nights' in submitted_fairness %}checked{% endif %}><label class="form-check-label" for="f_n">야간 근무 공평 분배</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" name="fairness_options" value="fair_offs" id="f_o" {% if 'fair_offs' in submitted_fairness %}checked{% endif %}><label class="form-check-label" for="f_o">총 휴무일 공평 분배</label></div>
                        {% endwith %}
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header"><strong>시프트별 최소 필요 인원 (숙련도)</strong></div>
                    <div class="card-body">
                        {% with reqs_data=form_data.skill_requirements|default_if_none:form_data.get|get_item_simple:'skill_requirements' %}
                        <div class="row">
                        {% for s_name in shifts %}
                            <div class="col-md-4">
                                <strong>{{ s_name }}:</strong>
                                {% for skill in skills %}
                                <div class="form-group row mb-1">
                                    <label class="col-sm-4 col-form-label col-form-label-sm">{{ skill }}</label>
                                    <div class="col-sm-8">
                                        <input type="number" name="req_{{ s_name }}_{{ skill }}" value="{{ reqs_data|get_item_simple:s_name|get_item_simple:skill|default:0 }}" class="form-control form-control-sm" min="0">
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% endfor %}
                        </div>
                        {% endwith %}
                    </div>
                </div>
                 <div class="card mb-4">
                    <div class="card-header"><strong>간호사 정보 및 휴가 설정 (총 {{ submitted_num_nurses }}명)</strong></div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm">
                            <thead><tr><th>이름</th><th>숙련도</th><th>휴가 요청일 (예: 3,4,10)</th></tr></thead>
                            <tbody>
                            {% for i in submitted_num_nurses|get_range %}
                                {% with nurse=nurses_data|get_item:i %}
                                <tr>
                                    <td><input type="text" name="nurse_{{ i }}_name" value="{{ nurse.name }}" class="form-control form-control-sm"></td>
                                    <td>
                                        <select name="nurse_{{ i }}_skill" class="form-control form-control-sm">
                                            {% for skill_option in skills %}
                                            <option value="{{ skill_option }}" {% if nurse.skill == skill_option %}selected{% endif %}>{{ skill_option }}</option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td><input type="text" name="nurse_{{ i }}_vacation" value="{{ form_data|get_item_simple:i|default_if_none:'' }}" class="form-control form-control-sm" placeholder="쉼표로 구분"></td>
                                </tr>
                                {% endwith %}
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <button type="submit" class="btn btn-primary btn-lg mt-3 mb-3">고급 근무표 생성</button>
    </form>
    
    {# --- 결과 메시지 --- #}
    {% if error_message or success_message %}
    <hr class="my-4">
    <h3 class="mt-4">Optimization Result</h3>
    {% endif %}
    {% if error_message %}
        <div class="alert alert-danger" role="alert"><strong>오류:</strong> {{ error_message }}</div>
    {% endif %}
    {% if success_message and not error_message %}
        <div class="alert alert-success" role="alert">{{ success_message }}</div>
    {% endif %}

    {% if results %}
    <div class="card mt-3">
        <div class="card-header"><strong>2주 근무표</strong></div>
        <div class="table-responsive">
            <table class="table table-bordered table-sm schedule-table mb-0">
                <thead class="thead-light">
                    <tr>
                        <th>요일 / 시프트</th>
                        {% for day_name in schedule_weekdays %}
                            <th class="{% if day_name == '토' or day_name == '일' %}bg-info text-white{% endif %}">
                                Day {{ forloop.counter0|add:1 }} ({{ day_name }})
                            </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for shift_name in shifts %}
                    <tr>
                        <td><strong>{{ shift_name }}</strong></td>
                        {% for day in results.schedule.keys %}
                        <td>
                            <div class="nurse-list">
                            {% for nurse_idx in results.schedule|get_item:day|get_item:forloop.parentloop.counter0 %}
                                <div>간호사 {{ nurse_idx|add:1 }}</div>
                            {% empty %}
                                -
                            {% endfor %}
                            </div>
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="card mt-3">
        <div class="card-header"><strong>간호사별 근무일 수 요약</strong></div>
        <div class="card-body">
            <div class="row">
                <div class="col-lg-6">
                    <h6>총 근무일 (목표: {{ min_shifts_per_nurse }}~{{ max_shifts_per_nurse }}일)</h6><hr>
                    <div class="row">
                    {% for work_days in results.nurse_work_days %}
                        <div class="col-6 col-md-4 mb-2">
                            간호사 {{ forloop.counter }}: <strong>{{ work_days }}일</strong>
                        </div>
                    {% endfor %}
                    </div>
                </div>
                <div class="col-lg-6">
                    <h6>주말 근무일</h6><hr>
                    <div class="row">
                    {% for weekend_days in results.weekend_work_days %}
                        <div class="col-6 col-md-4 mb-2">
                            간호사 {{ forloop.counter }}: <strong>{{ weekend_days }}일</strong>
                        </div>
                    {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}