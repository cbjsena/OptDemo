{% extends "core/base.html" %}
{% load static %}
{% load resource_allocation_filters %}

{% block title %}Advanced Nurse Rostering Advanced Demo{% endblock %}

{% block styles %}
<style>
    .schedule-table th, .schedule-table td {
        text-align: center;
        vertical-align: middle;
        min-width: 90px;
        font-size: 0.8rem;
    }
    .schedule-table .nurse-list {
        font-size: 0.8rem;
        line-height: 1.5;
    }
    .stats-table {
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="h2">Advanced Nurse Rostering Demo</h1>
    <p>간호사 수, 근무 기간, 근무일 범위 등 다양한 조건을 설정하고, 숙련도, 휴가, 공정성 제약 등을 반영하여 최적의 근무표를 생성합니다.</p>

    <div class="card mb-4">
        <div class="card-body bg-light">
            <div class="form-row align-items-end">
                <div class="form-group col-md-3 col-lg-2">
                    <label for="num_nurses_get" class="small font-weight-bold">총 간호사 수</label>
                    <select id="num_nurses_get" name="num_nurses" class="form-control form-control-sm" onchange="submitSettingsForm()">
                        {% for i in num_nurses_options %}<option value="{{ i }}" {% if i == submitted_num_nurses %}selected{% endif %}>{{ i }}명</option>{% endfor %}
                    </select>
                </div>
                <div class="form-group col-md-3 col-lg-2">
                    <label for="num_days_get" class="small font-weight-bold">근무 기간 (일)</label>
                    <select id="num_days_get" name="num_days" class="form-control form-control-sm" onchange="submitSettingsForm()">
                         {% for i in num_days_options %}<option value="{{ i }}" {% if i == submitted_num_days %}selected{% endif %}>{{ i }}일</option>{% endfor %}
                    </select>
                </div>
                <div class="form-group col-md-3 col-lg-2">
                    <label for="min_shifts_get" class="small font-weight-bold">최소 근무일</label>
                    <select id="min_shifts_get" name="min_shifts" class="form-control form-control-sm" onchange="submitSettingsForm()">
                        {% for i in min_shifts_options %}<option value="{{ i }}" {% if i == submitted_min_shifts %}selected{% endif %}>{{ i }}일</option>{% endfor %}
                    </select>
                </div>
                <div class="form-group col-md-3 col-lg-2">
                    <label for="max_shifts_get" class="small font-weight-bold">최대 근무일</label>
                     <select id="max_shifts_get" name="max_shifts"  class="form-control form-control-sm" onchange="submitSettingsForm()">
                        {% for i in max_shifts_options %}<option value="{{ i }}" {% if i == submitted_max_shifts %}selected{% endif %}>{{ i }}일</option>{% endfor %}
                    </select>
                </div>
                <div class="form-group col-md-12 col-lg-4 text-lg-right mt-3 mt-lg-0">
                    <a href="{% url 'resource_allocation_app:nurse_rostering_advanced_demo' %}" class="btn btn-sm btn-warning">Default 설정</a>
                </div>
            </div>
        </div>
    </div>

    <form method="GET" id="settingsForm" style="display: none;"></form>

    <form method="POST">
        {% csrf_token %}
        <input type="hidden" name="problem_type" value="nurse_rostering" id="problem_type">
        <input type="hidden" name="num_nurses" value="{{ submitted_num_nurses }}">
        <input type="hidden" name="num_days" value="{{ submitted_num_days }}">
        <input type="hidden" name="min_shifts" value="{{ submitted_min_shifts }}">
        <input type="hidden" name="max_shifts" value="{{ submitted_max_shifts }}">

        <div class="row">
            <div class="col-lg-7">
                <div class="card mb-4">
                    <div class="card-header"><strong>간호사 정보 및 휴가 설정</strong></div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead class="thead-light"><tr><th>이름</th><th>숙련도</th><th>휴가 요청일 (예: 3,4,10)</th></tr></thead>
                            <tbody>
                            {% for nurse in nurses_data %}
                                <tr>
                                    <td><input type="text" name="nurse_{{ forloop.counter0 }}_name" value="{{ nurse.name }}" class="form-control form-control-sm"></td>
                                    <td>
                                        <select name="nurse_{{ forloop.counter0 }}_skill" class="form-control form-control-sm nurse-skill-select">
                                            {% for skill in skill_options %}
                                            <option value="{{ skill }}" {% if nurse.skill == skill %}selected{% endif %}>{{ skill }}</option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td><input type="text" name="nurse_{{ forloop.counter0 }}_vacation" value="{{ submitted_vacations|get_item:forloop.counter0 }}" class="form-control form-control-sm" placeholder="쉼표로 구분"></td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {# --- 숙련도별 인원 수 표시 --- #}
                    <div class="card-footer bg-white text-muted small">
                        <strong>숙련도별 인원:</strong>
                        {% for skill in skill_options %}
                            <span class="ml-3">
                                {{ skill }}: <strong id="count_skill_{{ skill }}" class="text-dark">0</strong>명
                            </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="col-lg-5">
                <div class="card mb-4">
                    <div class="card-header"><strong>시프트 및 공정성 제약</strong></div>
                    <div class="card-body">
                        <h6>시프트별 최소 필요 인원</h6>
                        {% for s_name in shifts %}
                            <strong>{{ s_name }}:</strong>
                            <div class="form-row">
                                {% for skill in skill_options %}
                                <div class="col">
                                    <label class="small">{{ skill }}</label>
                                    <input type="number" name="req_{{ s_name }}_{{ skill }}" value="{{ skill_requirements|get_item:s_name|get_item:skill }}" class="form-control form-control-sm skill-req" data-shift="{{ s_name }}" min="0">
                                </div>
                                {% endfor %}
                                <div class="col">
                                    <label class="small font-weight-bold">총원</label>
                                    <input type="number" id="total_req_{{ s_name }}" class="form-control form-control-sm" readonly>
                                </div>
                            </div>
                        {% endfor %}
                        <hr>
                        <h6>적용할 공정성 목표</h6>
<!--                        <div class="form-check">-->
<!--                            <input class="form-check-input" type="checkbox" name="fairness_options" value="fair_weekends"-->
<!--                                   id="f_w" {% if 'fair_weekends' in submitted_fairness|default_if_none:'' or not submitted_fairness %}checked{% endif %}><label class="form-check-label" for="f_w">주말 근무 공평 분배</label></div>-->
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="fairness_options" value="fair_nights"
                                   id="f_n" {% if 'fair_nights' in submitted_fairness|default_if_none:'' or not submitted_fairness %}checked{% endif %}><label class="form-check-label" for="f_n">야간 근무 공평 분배</label></div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="fairness_options" value="fair_offs"
                                   id="f_o" {% if 'fair_offs' in submitted_fairness|default_if_none:'' or not submitted_fairness %}checked{% endif %}><label class="form-check-label" for="f_o">총 휴무일 공평 분배</label></div>
                    </div>
                </div>
            </div>
        </div>
        <button type="submit" class="btn btn-primary btn-lg mt-3 mb-3">고급 근무표 생성</button>
    </form>

    {% if error_message or success_message %}
    <hr class="my-4">
    <h3 class="mt-4">Optimization Result</h3>
    {% endif %}
    {% if error_message %}
        <div class="alert alert-danger" role="alert"><strong>오류:</strong> {{ error_message }}</div>
    {% endif %}
    {% if success_message and not error_message %}
        <div class="alert alert-success" role="alert">{{ success_message }}</div>
    {% endif %}

    {% if results %}
    <div class="card mt-3">
        <div class="card-header"><strong>생성된 근무표</strong></div>
        <div class="table-responsive">
            <table class="table table-bordered table-sm schedule-table mb-0">
                <thead class="thead-light">
                    <tr>
                        <th>요일 / 시프트</th>
                        {% for day_name in schedule_weekdays %}
                            <th class="{% if day_name == '토' or day_name == '일' %}bg-info text-white{% endif %}">
                                Day {{ forloop.counter0|add:1 }} ({{ day_name }})
                            </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for shift_name in shifts %}
                    <tr>
                        <td><strong>{{ shift_name }}</strong></td>
                        {% for day in results.schedule.keys %}
                        <td>
                            <div class="nurse-list">
                            {% for nurse_id in results.schedule|get_item:day|get_item:forloop.parentloop.counter0 %}
                                <div>{{ nurses_data|get_item:nurse_id|get_item:'name' }}</div>
                            {% empty %}
                                -
                            {% endfor %}
                            </div>
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="card mt-3">
        <div class="card-header"><strong>간호사별 근무 통계</strong></div>
        <div class="table-responsive">
            <table class="table table-sm table-striped table-hover stats-table mb-0">
                <thead class="thead-light">
                    <tr>
                        <th>간호사</th>
                        <th>숙련도</th>
                        <th>총 근무일</th>
                        <th>야간 근무</th>
                        <th>주말 근무</th>
                        <th>총 휴무일</th>
                    </tr>
                </thead>
                <tbody>
                {% for nurse in nurses_data %}
                    {% with stats=results.nurse_stats|get_item:forloop.counter0 %}
                    <tr>
                        <td>{{ nurse.name }}</td>
                        <td>{{ nurse.skill }}</td>
                        <td>{{ stats.total }}일</td>
                        <td>{{ stats.nights }}일</td>
                        <td>{{ stats.weekends }}일</td>
                        <td>{{ stats.offs }}일</td>
                    </tr>
                    {% endwith %}
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
    function submitSettingsForm() {
        const settingsForm = document.getElementById('settingsForm');
        settingsForm.innerHTML = ''; // 폼 초기화

        const controls = ['num_nurses_get', 'num_days_get', 'min_shifts_get', 'max_shifts_get'];
        const names = ['num_nurses', 'num_days', 'min_shifts', 'max_shifts'];
        controls.forEach((id, index) => {
            const select = document.getElementById(id);
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = names[index];
            hiddenInput.value = select.value;
            settingsForm.appendChild(hiddenInput);
        });

        const numNurses = document.getElementById('num_nurses_get').value;
        for (let i = 0; i < numNurses; i++) {
            ['name', 'skill', 'vacation'].forEach(field => {
                const element = document.querySelector(`[name="nurse_${i}_${field}"]`);
                if (element) {
                    let hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = `nurse_${i}_${field}`;
                    hiddenInput.value = element.value;
                    settingsForm.appendChild(hiddenInput);
                }
            });
        }
        settingsForm.submit();
    }

    // [신규] 총 필요 인력 자동 계산 함수
    function updateShiftTotals() {
        const shifts = [{% for s in shifts %}"{{ s }}",{% endfor %}];
        shifts.forEach(shiftName => {
            let total = 0;
            document.querySelectorAll(`.skill-req[data-shift="${shiftName}"]`).forEach(input => {
                total += parseInt(input.value) || 0;
            });
            document.getElementById(`total_req_${shiftName}`).value = total;
        });
    }

    // 숙련도별 인원 수를 계산하고 화면에 업데이트하는 함수
    function updateSkillCounts() {
        const skillOptions = [{% for skill in skill_options %}"{{ skill }}",{% endfor %}];
        const counts = {};
        skillOptions.forEach(skill => counts[skill] = 0);

        // 모든 숙련도 드롭다운의 현재 값을 읽어와 카운트
        document.querySelectorAll('.nurse-skill-select').forEach(select => {
            counts[select.value]++;
        });

        // 화면에 카운트 업데이트
        skillOptions.forEach(skill => {
            document.getElementById(`count_skill_${skill}`).innerText = counts[skill];
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // 페이지 로드 시 총 인원 계산
        updateShiftTotals();

        // 숙련도별 필요 인원 변경 시마다 총 인원 다시 계산
        document.querySelectorAll('.skill-req').forEach(input => {
            input.addEventListener('input', updateShiftTotals);
        });

        // 페이지 로드 시, 그리고 숙련도 변경 시 인원 수 업데이트
        updateSkillCounts();
        document.querySelectorAll('.nurse-skill-select').forEach(select => {
            select.addEventListener('change', updateSkillCounts);
        });

    });
</script>
{% endblock %}