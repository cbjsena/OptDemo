{% extends "core/base.html" %}
{% load static %}
{% load resource_allocation_filters %}

{% block title %}Nurse Rostering Demo{% endblock %}

{% block styles %}
<style>
    .schedule-table th, .schedule-table td {
        text-align: center;
        vertical-align: middle;
        min-width: 80px;
    }
    .nurse-list {
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="h2">Nurse Rostering Demo</h1>
    <p>간호사 스케줄링 문제는 병원의 필수 인력을 유지하면서, 근무자들의 복잡한 요구사항과 규정을 만족시키는 근무표를 작성하는 문제입니다.
        주말 근무 공정성, 최소 휴식 시간 보장 등 복잡한 제약 조건을 반영하여 2주간의 간호사 근무표를 생성합니다.</p>

    <form method="POST" id="rosterForm">
        {% csrf_token %}
        <input type="hidden" name="problem_type" value="nurse_rostering" id="problem_type">

        <div class="card mb-4">
            <div class="card-header"><strong>근무 조건 설정</strong></div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 form-group">
                        <label for="num_nurses">총 간호사 수</label>
                        <input type="number" class="form-control" id="num_nurses" name="num_nurses" value="{{ num_nurses }}" min="1">
                    </div>
                    <div class="col-md-3 form-group">
                        <label for="num_days">근무 기간 (일)</label>
                        <input type="number" class="form-control" id="num_days" name="num_days" value="{{ num_days }}" min="1">
                    </div>
                    <div class="col-md-3 form-group">
                        <label for="min_shifts">간호사별 최소 근무일</label>
                        <input type="number" class="form-control" id="min_shifts" name="min_shifts" value="{{ min_shifts_per_nurse }}" min="0">
                    </div>
                    <div class="col-md-3 form-group">
                        <label for="max_shifts">간호사별 최대 근무일</label>
                        <input type="number" class="form-control" id="max_shifts" name="max_shifts" value="{{ max_shifts_per_nurse }}" min="0">
                    </div>
                </div>
                <hr>
                <h6>시프트별 필요 인원</h6>
                <div class="row">
                    {% for shift_name, required in shift_requests.items %}
                    <div class="col-md-4 form-group">
                        <label for="shift_{{ forloop.counter0 }}_req">{{ shift_name }}</label>
                        <input type="number" class="form-control" id="shift_{{ forloop.counter0 }}_req" name="shift_{{ forloop.counter0 }}_req" value="{{ required }}" min="0">
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <button type="submit" class="btn btn-primary btn-lg mt-3 mb-3">최적 근무표 생성</button>
    </form>

    {# 1. 결과 메세지 #}
    {% if success_save_message%}
        <div class="alert alert-success" role="alert">{{ success_save_message }}</div>
    {% endif %}
    {% if opt_results is not None or error_message or success_message %}
    <hr class="my-4">
    <h3 class="mt-4">Optimization Results ({{ active_submenu }})</h3>
    {% endif %}
    {% if error_message %}
        <div class="alert alert-danger" role="alert"><strong>오류:</strong> {{ error_message }}</div>
    {% endif %}
    {% if success_message and not error_message %}
        <div class="alert alert-success" role="alert">{{ success_message }}</div>
    {% endif %}

    {% if results %}
    <div class="card mt-4">
        <div class="card-header"><strong>결과 요약</strong></div>
        <div class="card-body">
            <p class="h4"><strong>총 페널티: {{ results.total_penalty }}</strong></p>
            <p><small>처리 시간: {{ processing_time_seconds }} 초</small></p>
        </div>
    </div>

    <div class="card mt-3">
        <div class="card-header"><strong>2주 근무표</strong></div>
        <div class="table-responsive">
            <table class="table table-bordered table-sm schedule-table mb-0">
                <thead class="thead-light">
                    <tr>
                        <th>요일 / 시프트</th>
                        {% for day_name in schedule_weekdays %}
                            <th class="{% if day_name == '토' or day_name == '일' %}bg-info text-white{% endif %}">
                                Day {{ forloop.counter0|add:1 }} ({{ day_name }})
                            </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for shift_name in shifts %}
                    <tr>
                        <td><strong>{{ shift_name }}</strong></td>
                        {% for day in results.schedule.keys %}
                        <td>
                            <div class="nurse-list">
                            {% for nurse_idx in results.schedule|get_item:day|get_item:forloop.parentloop.counter0 %}
                                <div>간호사 {{ nurse_idx|add:1 }}</div>
                            {% empty %}
                                -
                            {% endfor %}
                            </div>
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="card mt-3">
        <div class="card-header"><strong>간호사별 근무일 수 요약</strong></div>
        <div class="card-body">
            <div class="row">
                <div class="col-lg-6">
                    <h6>총 근무일 (목표: {{ min_shifts_per_nurse }}~{{ max_shifts_per_nurse }}일)</h6><hr>
                    <div class="row">
                    {% for work_days in results.nurse_work_days %}
                        <div class="col-6 col-md-4 mb-2">
                            간호사 {{ forloop.counter }}: <strong>{{ work_days }}일</strong>
                        </div>
                    {% endfor %}
                    </div>
                </div>
                <div class="col-lg-6">
                    <h6>주말 근무일</h6><hr>
                    <div class="row">
                    {% for weekend_days in results.weekend_work_days %}
                        <div class="col-6 col-md-4 mb-2">
                            간호사 {{ forloop.counter }}: <strong>{{ weekend_days }}일</strong>
                        </div>
                    {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}