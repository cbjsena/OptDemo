{% extends "core/base.html" %}
{% load static %}
{% load resource_allocation_filters %} {# get_range, get_item_simple 사용 #}

{% block title %}Data Center Capacity Planning - Demo{% endblock %}

{% block styles %}
<style>
    /* ... (이전 데모 페이지의 error/success 메시지 스타일 등 공통 스타일 유지) ... */
    .form-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        border: 1px solid #e0e0e0;
        border-radius: .3rem;
        background-color: #f9f9f9;
    }
    .form-section h4 {
        margin-bottom: 1rem;
        color: #0056b3;
        border-bottom: 1px solid #ccc;
        padding-bottom: 0.5rem;
    }
    .input-group-text.short {
        width: 100px; /* 라벨 너비 고정용 */
        font-size: 0.85rem;
    }
    .results-table th, .results-table td {
        text-align: right; vertical-align: middle;
    }
    .results-table th:first-child, .results-table td:first-child {
        text-align: left;
    }
    .error-message, .success-message {
        padding: .75rem 1.25rem; margin-bottom: 1rem;
        border: 1px solid transparent; border-radius: .25rem;
    }
    .error-message { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }
    .success-message { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Data Center Capacity Planning Demo</h1>
    </div>
    <p>데이터 센터의 총 예산, 전력, 공간 제약 하에서 여러 서버 유형과 서비스 수요를 고려하여 총 이익을 최대화하는 서버 구매 및 서비스 할당 계획을 수립합니다.</p>

    <form method="GET" class="mb-3 form-inline">
        <div class="form-group mr-2">
            <label for="num_server_types_to_show" class="mr-2">서버 유형 수 (1-3):</label>
            <select name="num_server_types_to_show" id="num_server_types_to_show" class="form-control form-control-sm" onchange="this.form.submit()">
                {% for i in num_server_types_options %}
                    <option value="{{ i }}" {% if i == submitted_num_server_types %}selected{% endif %}>{{ i }}개</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group mr-2">
            <label for="num_services_to_show" class="mr-2">서비스 종류 수 (1-3):</label>
            <select name="num_services_to_show" id="num_services_to_show" class="form-control form-control-sm" onchange="this.form.submit()">
                {% for i in num_services_options %}
                    <option value="{{ i }}" {% if i == submitted_num_services %}selected{% endif %}>{{ i }}개</option>
                {% endfor %}
            </select>
        </div>
        <noscript><button type="submit" class="btn btn-sm btn-secondary">항목 수 변경 적용</button></noscript>
    </form>

    <form method="POST">
        {% csrf_token %}
        <input type="hidden" name="num_server_types" value="{{ submitted_num_server_types }}">
        <input type="hidden" name="num_services" value="{{ submitted_num_services }}">

        {# form_data|get_item_simple:key_name -> get_item_simple(form_data, key_name)] #}
        <div class="form-section">
            <h4>1. 글로벌 제약 조건</h4>
            <div class="form-row">
                <div class="form-group col-md-4">
                    <label for="total_budget">총 예산 (Total Budget):</label>
                    <input type="number" step="any" min="0" class="form-control form-control-sm" id="total_budget" name="total_budget"
                           value="{% with key_name='total_budget' %}{{ form_data|get_item_simple:key_name|default_if_none:'100000' }}{% endwith %}" required>
                </div>
                <div class="form-group col-md-4">
                    <label for="total_power_kva">총 가용 전력 (kVA):</label>
                    <input type="number" step="any" min="0" class="form-control form-control-sm" id="total_power_kva" name="total_power_kva"
                           value="{% with key_name='total_power_kva' %}{{ form_data|get_item_simple:key_name|default_if_none:'50' }}{% endwith %}" required>
                </div>
                <div class="form-group col-md-4">
                    <label for="total_space_sqm">총 가용 공간 (sqm):</label>
                    <input type="number" step="any" min="0" class="form-control form-control-sm" id="total_space_sqm" name="total_space_sqm"
                           value="{% with key_name='total_space_sqm' %}{{ form_data|get_item_simple:key_name|default_if_none:'10' }}{% endwith %}" required>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h4>2. 서버 유형별 정보 (총 {{ submitted_num_server_types }}개)</h4>
            {% for i in submitted_num_server_types|get_range %}
            <fieldset class="mb-3 p-3 border rounded">
                <legend class="h6">서버 유형 {{ i|add:1 }}</legend>
                <div class="form-group">
                    <label for="server_{{ i }}_id">유형 ID:</label>
                    <input type="text" class="form-control form-control-sm" id="server_{{ i }}_id" name="server_{{ i }}_id"
                           value="{% with key_name='server_'|add:i|add:'_id' %}{{ form_data|get_item_simple:key_name|default_if_none:'Srv'|add:i|add:1|stringformat:'s' }}{% endwith %}">
                </div>
                <div class="form-row">
                    <div class="form-group col-md-2"><label for="server_{{ i }}_cost">비용:</label><input type="number" step="any" min="0" class="form-control form-control-sm" name="server_{{ i }}_cost" value="{% with k='server_'|add:i|add:'_cost'%}{{form_data|get_item_simple:k|default_if_none:'5000'}}{%endwith%}"></div>
                    <div class="form-group col-md-2"><label for="server_{{ i }}_cpu_cores">CPU(코어):</label><input type="number" min="0" class="form-control form-control-sm" name="server_{{ i }}_cpu_cores" value="{% with k='server_'|add:i|add:'_cpu_cores'%}{{form_data|get_item_simple:k|default_if_none:'64'}}{%endwith%}"></div>
                    <div class="form-group col-md-2"><label for="server_{{ i }}_ram_gb">RAM(GB):</label><input type="number" min="0" class="form-control form-control-sm" name="server_{{ i }}_ram_gb" value="{% with k='server_'|add:i|add:'_ram_gb'%}{{form_data|get_item_simple:k|default_if_none:'256'}}{%endwith%}"></div>
                    <div class="form-group col-md-2"><label for="server_{{ i }}_storage_tb">스토리지(TB):</label><input type="number" step="any" min="0" class="form-control form-control-sm" name="server_{{ i }}_storage_tb" value="{% with k='server_'|add:i|add:'_storage_tb'%}{{form_data|get_item_simple:k|default_if_none:'10'}}{%endwith%}"></div>
                    <div class="form-group col-md-2"><label for="server_{{ i }}_power_kva">전력(kVA):</label><input type="number" step="any" min="0" class="form-control form-control-sm" name="server_{{ i }}_power_kva" value="{% with k='server_'|add:i|add:'_power_kva'%}{{form_data|get_item_simple:k|default_if_none:'0.5'}}{%endwith%}"></div>
                    <div class="form-group col-md-2"><label for="server_{{ i }}_space_sqm">공간(sqm):</label><input type="number" step="any" min="0" class="form-control form-control-sm" name="server_{{ i }}_space_sqm" value="{% with k='server_'|add:i|add:'_space_sqm'%}{{form_data|get_item_simple:k|default_if_none:'0.2'}}{%endwith%}"></div>
                </div>
            </fieldset>
            {% endfor %}
        </div>

        <div class="form-section">
            <h4>3. 서비스 수요별 정보 (총 {{ submitted_num_services }}개)</h4>
            {% for i in submitted_num_services|get_range %}
            <fieldset class="mb-3 p-3 border rounded">
                <legend class="h6">서비스 {{ i|add:1 }}</legend>
                <div class="form-group">
                     <label for="service_{{ i }}_id">서비스 ID:</label>
                     <input type="text" class="form-control form-control-sm" id="service_{{ i }}_id" name="service_{{ i }}_id"
                            value="{% with key_name='service_'|add:i|add:'_id' %}{{ form_data|get_item_simple:key_name|default_if_none:'Svc'|add:i|add:1|stringformat:'s' }}{% endwith %}">
                </div>
                <div class="form-row">
                    <div class="form-group col-md-2"><label for="service_{{ i }}_revenue_per_unit">단위당 수익:</label><input type="number" step="any" min="0" class="form-control form-control-sm" name="service_{{ i }}_revenue_per_unit" value="{% with k='service_'|add:i|add:'_revenue_per_unit'%}{{form_data|get_item_simple:k|default_if_none:'100'}}{%endwith%}"></div>
                    <div class="form-group col-md-2"><label for="service_{{ i }}_req_cpu_cores">요구CPU:</label><input type="number" min="0" class="form-control form-control-sm" name="service_{{ i }}_req_cpu_cores" value="{% with k='service_'|add:i|add:'_req_cpu_cores'%}{{form_data|get_item_simple:k|default_if_none:'4'}}{%endwith%}"></div>
                    <div class="form-group col-md-2"><label for="service_{{ i }}_req_ram_gb">요구RAM:</label><input type="number" min="0" class="form-control form-control-sm" name="service_{{ i }}_req_ram_gb" value="{% with k='service_'|add:i|add:'_req_ram_gb'%}{{form_data|get_item_simple:k|default_if_none:'8'}}{%endwith%}"></div>
                    <div class="form-group col-md-2"><label for="service_{{ i }}_req_storage_tb">요구스토리지:</label><input type="number" step="any" min="0" class="form-control form-control-sm" name="service_{{ i }}_req_storage_tb" value="{% with k='service_'|add:i|add:'_req_storage_tb'%}{{form_data|get_item_simple:k|default_if_none:'0.1'}}{%endwith%}"></div>
                    <div class="form-group col-md-2"><label for="service_{{ i }}_max_units">최대수요(유닛):</label><input type="number" min="0" class="form-control form-control-sm" name="service_{{ i }}_max_units" value="{% with k='service_'|add:i|add:'_max_units'%}{{form_data|get_item_simple:k|default_if_none:'50'}}{%endwith%}"></div>
                </div>
            </fieldset>
            {% endfor %}
        </div>

        <button type="submit" class="btn btn-primary btn-lg mt-3 mb-3">데이터 센터 용량 계획 최적화 실행</button>
    </form>

    {% if results is not None or error_message or success_message %}
    <hr class="my-4">
    <h3 class="mt-4">Optimization Results</h3>
    {% endif %}

    {% if error_message %}
        <div class="error-message" role="alert"><strong>오류:</strong> {{ error_message }}</div>
    {% endif %}
    {% if success_message and not error_message %}
        <div class="success-message" role="alert">{{ success_message }}</div>
    {% endif %}

    {% if results %}
    <div class="card mt-4">
        <div class="card-header"><strong>최적화 결과 요약</strong></div>
        <div class="card-body">
            <p><strong>계산된 총 이익:</strong> {{ results.total_profit|floatformat:2 }}</p>
            <p><strong>총 서버 구매 비용:</strong> {{ results.total_server_cost|floatformat:2 }}</p>
            <p><strong>총 서비스 수익:</strong> {{ results.total_service_revenue|floatformat:2 }}</p>
            <hr>
            <p><strong>입력된 총 예산:</strong> {{ form_data.total_budget|default_if_none:"N/A" }}</p>
            <p><strong>사용된 총 전력:</strong> {{ results.total_power_used|floatformat:2 }} / {{ form_data.total_power_kva|default_if_none:"N/A" }} kVA</p>
            <p><strong>사용된 총 공간:</strong> {{ results.total_space_used|floatformat:2 }} / {{ form_data.total_space_sqm|default_if_none:"N/A" }} sqm</p>
            <p><small>처리 시간: {{ processing_time_seconds }} 초</small></p>
        </div>
    </div>

    {% if results.purchased_servers %}
    <div class="card mt-3">
        <div class="card-header"><strong>구매된 서버 수량</strong></div>
        <div class="table-responsive">
            <table class="table table-sm results-table mb-0">
                <thead class="thead-light"><tr><th>서버 유형 ID</th><th>구매 수량</th><th>단가</th><th>유형별 총 비용</th></tr></thead>
                <tbody>
                    {% for server in results.purchased_servers %}
                    <tr><td>{{ server.type_id }}</td><td>{{ server.count }}</td><td>{{ server.unit_cost|floatformat:2 }}</td><td>{{ server.total_cost_for_type|floatformat:2 }}</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {% if results.service_allocations %}
    <div class="card mt-3">
        <div class="card-header"><strong>서비스별 제공 유닛 및 수익</strong></div>
        <div class="table-responsive">
            <table class="table table-sm results-table mb-0">
                <thead class="thead-light"><tr><th>서비스 ID</th><th>총 제공 유닛 수</th><th>서비스별 총 수익</th><th>세부 할당 (서버유형: 유닛수)</th></tr></thead>
                <tbody>
                    {% for service in results.service_allocations %}
                    <tr>
                        <td>{{ service.service_id }}</td>
                        <td>{{ service.total_units_provided }}</td>
                        <td>{{ service.revenue_from_service|floatformat:2 }}</td>
                        <td>
                            {% for alloc in service.allocations %}
                                {{ alloc.server_type_id }}: {{ alloc.units_allocated }}{% if not forloop.last %}, {% endif %}
                            {% empty %}
                                -
                            {% endfor %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {% elif request.method == 'POST' and not error_message and not success_message %}
        <p class="text-muted mt-3"><em>최적화 결과가 없습니다. 입력값을 확인하거나, 솔버가 해를 찾지 못했을 수 있습니다.</em></p>
    {% endif %}

</div>
{% endblock %}

{% block scripts %}
<script>
    console.log("Data Center Capacity Planning Demo page script loaded.");
    // 항목 수 변경 시 GET 요청으로 페이지를 다시 로드하므로, 특별한 JS는 현재 필요 없음.
</script>
{% endblock %}