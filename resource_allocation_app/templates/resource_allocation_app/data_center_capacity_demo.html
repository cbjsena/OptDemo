{% extends "core/base.html" %}
{% load static %}
{% load resource_allocation_filters %} {# get_range, get_item_simple 사용 #}

{% block title %}Data Center Capacity Planning - Demo{% endblock %}

{% block styles %}
<style>
    .form-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        border: 1px solid #e0e0e0;
        border-radius: .3rem;
        background-color: #f9f9f9;
    }
    .form-section h4 {
        margin-bottom: 1rem;
        color: #0056b3;
        border-bottom: 1px solid #ccc;
        padding-bottom: 0.5rem;
    }
    .input-group-text.short {
        width: 100px; /* 라벨 너비 고정용 */
        font-size: 0.85rem;
    }
    .results-table th, .results-table td {
        text-align: right; vertical-align: middle;
    }
    .results-table th:first-child, .results-table td:first-child {
        text-align: left;
    }
    .chart-container {
        width: 100%;
        max-width: 450px;
        margin: 15px auto;
        padding: 10px;
        border: 1px solid #eee;
        border-radius: 5px;
        background-color: #fff;
    }
    .charts-row {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: space-around;
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Data Center Capacity Planning Demo</h1>
    </div>
    <p>데이터 센터의 총 예산, 전력, 공간 제약 하에서 여러 서버 유형과 서비스 수요를 고려하여 총 이익을 최대화하는 서버 구매 및 서비스 할당 계획을 수립합니다.</p>

    <!-- [신규] 설정 변경을 위한 숨겨진 GET 폼 -->
    <form method="GET" id="settingsForm" style="display: none;"></form>

    <!-- [수정] 상단 컨트롤러 -->
    <div class="card mb-4">
        <div class="card-body bg-light">
            <div class="form-row align-items-end">
                <div class="form-group col-md-4">
                    <label for="num_server_types_to_show" class="small font-weight-bold">서버 유형 수</label>
                    <select name="num_server_types_to_show" id="num_server_types_to_show" class="form-control form-control-sm" onchange="submitSettingsForm()">
                        {% for i in num_server_types_options %}
                            <option value="{{ i }}" {% if i == submitted_num_server_types %}selected{% endif %}>{{ i }}개</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group col-md-4">
                    <label for="num_services_to_show" class="small font-weight-bold">서비스 종류 수</label>
                    <select name="num_services_to_show" id="num_services_to_show" class="form-control form-control-sm" onchange="submitSettingsForm()">
                        {% for i in num_services_options %}
                            <option value="{{ i }}" {% if i == submitted_num_services %}selected{% endif %}>{{ i }}개</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group col-md-4 text-md-right">
                    <a href="{% url 'resource_allocation_app:data_center_capacity_demo' %}" class="btn btn-sm btn-warning">Default</a>
                </div>
            </div>
        </div>
    </div>

    <form method="POST">
        {% csrf_token %}
        <input type="hidden" name="problem_type" value="datacenter" id="problem_type">
        <input type="hidden" name="num_server_types" value="{{ submitted_num_server_types }}">
        <input type="hidden" name="num_services" value="{{ submitted_num_services }}">

        <div class="card mb-4">
            <div class="card-header"><strong>1. 글로벌 제약 조건</strong></div>
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label for="total_budget">총 예산 (Total Budget):</label>
                        <input type="number" step="any" min="0" class="form-control form-control-sm" id="total_budget" name="total_budget"
                               value="{{ global_constraints.total_budget }}" required>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="total_power_kva">총 가용 전력 (kVA):</label>
                        <input type="number" step="any" min="0" class="form-control form-control-sm" id="total_power_kva" name="total_power_kva"
                               value="{{ global_constraints.total_power_kva }}" required>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="total_space_sqm">총 가용 공간 (sqm):</label>
                        <input type="number" step="any" min="0" class="form-control form-control-sm" id="total_space_sqm" name="total_space_sqm"
                               value="{{ global_constraints.total_space_sqm }}" required>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header"><strong>2. 서버별 정보 (총 {{ submitted_num_server_types }}개)</strong></div>
            <div class="card-body table-responsive">
                <table class="table table-sm table-bordered">
                    <thead class="thead-light">
                        <tr>
                            <th>서버 ID</th><th>비용</th><th>CPU(코어)</th><th>RAM(GB)</th>
                            <th>스토리지(TB)</th><th>전력(kVA)</th><th>공간(sqm)</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for server in servers_data %}
                        <tr>
                            <td><input type="text" name="server_{{ forloop.counter0 }}_id" value="{{ server.id }}" class="form-control form-control-sm"></td>
                            <td><input type="number" name="server_{{ forloop.counter0 }}_cost" value="{{ server.cost }}" class="form-control form-control-sm"></td>
                            <td><input type="number" name="server_{{ forloop.counter0 }}_cpu_cores" value="{{ server.cpu_cores }}" class="form-control form-control-sm"></td>
                            <td><input type="number" name="server_{{ forloop.counter0 }}_ram_gb" value="{{ server.ram_gb }}" class="form-control form-control-sm"></td>
                            <td><input type="number" name="server_{{ forloop.counter0 }}_storage_tb" value="{{ server.storage_tb }}" class="form-control form-control-sm"></td>
                            <td><input type="number" name="server_{{ forloop.counter0 }}_power_kva" value="{{ server.power_kva }}" class="form-control form-control-sm"></td>
                            <td><input type="number" name="server_{{ forloop.counter0 }}_space_sqm" value="{{ server.space_sqm }}" class="form-control form-control-sm"></td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header"><strong>3. 서비스 수요별 정보 (총 {{ submitted_num_services }}개)</strong></div>
            <div class="card-body table-responsive">
                <table class="table table-sm table-bordered">
                     <thead class="thead-light">
                        <tr>
                            <th>서비스 ID</th><th>단위당 수익</th><th>요구CPU</th>
                            <th>요구RAM</th><th>요구스토리지</th><th>최대유닛</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for service in services_data %}
                        <tr>
                            <td><input type="text" name="service_{{ forloop.counter0 }}_id" value="{{ service.id }}" class="form-control form-control-sm"></td>
                            <td><input type="number" name="service_{{ forloop.counter0 }}_revenue_per_unit" value="{{ service.revenue_per_unit }}" class="form-control form-control-sm"></td>
                            <td><input type="number" name="service_{{ forloop.counter0 }}_req_cpu_cores" value="{{ service.req_cpu_cores }}" class="form-control form-control-sm"></td>
                            <td><input type="number" name="service_{{ forloop.counter0 }}_req_ram_gb" value="{{ service.req_ram_gb }}" class="form-control form-control-sm"></td>
                            <td><input type="number" name="service_{{ forloop.counter0 }}_req_storage_tb" value="{{ service.req_storage_tb }}" class="form-control form-control-sm"></td>
                            <td><input type="number" name="service_{{ forloop.counter0 }}_max_units" value="{{ service.max_units }}" class="form-control form-control-sm"></td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <button type="submit" class="btn btn-primary btn-lg mt-3 mb-3">데이터 센터 용량 계획 최적화 실행</button>
    </form>

        {# 1. 결과 메세지 #}
    {% if success_save_message%}
        <div class="alert alert-success" role="alert">{{ success_save_message }}</div>
    {% endif %}
    {% if opt_results is not None or error_message or success_message %}
    <hr class="my-4">
    <h3 class="mt-4">Optimization Results ({{ active_submenu }})</h3>
    {% endif %}
    {% if error_message %}
        <div class="alert alert-danger" role="alert"><strong>오류:</strong> {{ error_message }}</div>
    {% endif %}
    {% if success_message and not error_message %}
        <div class="alert alert-success" role="alert">{{ success_message }}</div>
    {% endif %}

    {# 2. 결과 요약 및 시각화 #}
    {% if results %}
    <div class="card mt-4">
        <div class="card-header"><strong>최적화 결과 요약</strong></div>
        <div class="card-body">
            <p><strong>계산된 총 이익:</strong> {{ results.total_profit }}</p>
            <p><strong>총 서버 구매 비용:</strong> {{ results.total_server_cost }}</p>
            <p><strong>총 서비스 수익:</strong> {{ results.total_service_revenue}}</p>
            <hr>
            <p><strong>입력된 총 예산:</strong> {{ form_data.total_budget|default_if_none:"N/A" }}</p>
            <p><strong>사용된 총 전력:</strong> {{ results.total_power_used }} / {{ form_data.total_power_kva|default_if_none:"N/A" }} kVA</p>
            <p><strong>사용된 총 공간:</strong> {{ results.total_space_used }} / {{ form_data.total_space_sqm|default_if_none:"N/A" }} sqm</p>
            <p><small>처리 시간: {{ processing_time_seconds }} 초</small></p>
        </div>
    </div>

    {# --- 차트 표시 영역 --- #}
    <div class="charts-row mt-4">
        {% if chart_data_json %}
            {% if chart_data_py and chart_data_py.purchased_servers %}
            <div class="chart-container">
                <h6>구매 서버 수량</h6>
                <canvas id="purchasedServersChart"></canvas>
            </div>
            {% endif %}
            {% if chart_data_py and chart_data_py.budget_utilization %}
            <div class="chart-container">
                <h6>예산 활용률 (%)</h6>
                <canvas id="budgetUtilizationChart"></canvas>
            </div>
            {% endif %}
        {% endif %}
    </div>
    <div class="charts-row">
        {% if chart_data_json %}
            {% if chart_data_py and chart_data_py.power_utilization %}
            <div class="chart-container">
                <h6>전력 활용률 (%)</h6>
                <canvas id="powerUtilizationChart"></canvas> {# <--- 이 ID 확인 #}
            </div>
            {% endif %}
            {% if chart_data_py and chart_data_py.space_utilization %}
            <div class="chart-container">
                <h6>공간 활용률 (%)</h6>
                <canvas id="spaceUtilizationChart"></canvas> {# <--- 이 ID 확인 #}
            </div>
            {% endif %}
        {% endif %}
    </div>

    {% if results.purchased_servers %}
    <div class="card mt-3">
        <div class="card-header"><strong>구매된 서버 수량</strong></div>
        <div class="table-responsive">
            <table class="table table-sm results-table mb-0">
                <thead class="thead-light"><tr><th>서버 유형 ID</th><th>구매 수량</th><th>단가</th><th>유형별 총 비용</th></tr></thead>
                <tbody>
                    {% for server in results.purchased_servers %}
                    <tr><td>{{ server.type_id }}</td><td>{{ server.count }}</td><td>{{ server.unit_cost }}</td><td>{{ server.total_cost_for_type }}</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {% if results.service_allocations %}
    <div class="card mt-3">
        <div class="card-header"><strong>서비스별 제공 유닛 및 수익</strong></div>
        <div class="table-responsive">
            <table class="table table-sm results-table mb-0">
                <thead class="thead-light"><tr><th>서비스 ID</th><th>총 제공 유닛 수</th><th>서비스별 총 수익</th><th>세부 할당 (서버유형: 유닛수)</th></tr></thead>
                <tbody>
                    {% for service in results.service_allocations %}
                    <tr>
                        <td>{{ service.service_id }}</td>
                        <td>{{ service.total_units_provided }}</td>
                        <td>{{ service.revenue_from_service }}</td>
                        <td>
                            {% for alloc in service.allocations %}
                                {{ alloc.server_type_id }}: {{ alloc.units_allocated }}{% if not forloop.last %}; {% endif %}
                            {% empty %}
                                -
                            {% endfor %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {% elif request.method == 'POST' and not error_message and not success_message and not info_message %}
        <p class="text-muted mt-3"><em>최적화 결과가 없습니다. 입력값을 확인하거나, 솔버가 해를 찾지 못했을 수 있습니다.</em></p>
    {% endif %}

</div>
{% endblock %}

{% block scripts %}
<script>
    // 각 차트 인스턴스를 저장할 전역 변수 또는 객체
    var chartInstances = {};

    function destroyChartIfExists(chartId) {
        if (chartInstances[chartId]) {
            chartInstances[chartId].destroy();
            console.log(`Chart ${chartId} destroyed.`);
            delete chartInstances[chartId];
        }
    }

    function submitSettingsForm() {
        const settingsForm = document.getElementById('settingsForm');
        settingsForm.innerHTML = '';

        // 상단 컨트롤러 값 추가
        ['num_server_types_to_show', 'num_services_to_show'].forEach(id => {
            const select = document.getElementById(id);
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = select.name;
            hiddenInput.value = select.value;
            settingsForm.appendChild(hiddenInput);
        });

        // 글로벌 제약 조건 값 추가
        ['total_budget', 'total_power_kva', 'total_space_sqm'].forEach(id => {
            const input = document.getElementById(id);
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = input.name;
            hiddenInput.value = input.value;
            settingsForm.appendChild(hiddenInput);
        });

        // 현재 서버 정보 추가
        const numServers = {{ submitted_num_server_types }};
        for (let i = 0; i < numServers; i++) {
            ['id', 'cost', 'cpu_cores', 'ram_gb', 'storage_tb', 'power_kva', 'space_sqm'].forEach(field => {
                const element = document.querySelector(`input[name="server_${i}_${field}"]`);
                if (element) {
                    let hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = `server_${i}_${field}`;
                    hiddenInput.value = element.value;
                    settingsForm.appendChild(hiddenInput);
                }
            });
        }

        // 현재 서비스 정보 추가
        const numServices = {{ submitted_num_services }};
        for (let i = 0; i < numServices; i++) {
            ['id', 'revenue_per_unit', 'req_cpu_cores', 'req_ram_gb', 'req_storage_tb', 'max_units'].forEach(field => {
                const element = document.querySelector(`input[name="service_${i}_${field}"]`);
                if (element) {
                    let hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = `service_${i}_${field}`;
                    hiddenInput.value = element.value;
                    settingsForm.appendChild(hiddenInput);
                }
            });
        }

        settingsForm.submit();
    }

    // Chart.js 스크립트는 base.html에 이미 포함되어 있다고 가정합니다.
    // 이 스크립트는 DOM이 완전히 로드된 후에 실행되어야 합니다.
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Data Center Capacity Planning Demo page script loaded.");

        // 뷰에서 전달된 chart_data_json 사용 (Python dict는 chart_data_py로 가정)
        const chartDataJsonString = '{{ chart_data_json|safe|default_if_none:"{}" }}';

        try {
            const chartData = JSON.parse(chartDataJsonString);
            console.log("Parsed chart_data for script:", chartData);

            // 1. 구매 서버 수량 막대 차트
            if (chartData && chartData.purchased_servers && chartData.purchased_servers.labels && chartData.purchased_servers.data) {
                const psCanvasId = 'purchasedServersChart';
                const psCanvas = document.getElementById(psCanvasId);
                if (psCanvas) {
                    destroyChartIfExists(psCanvasId);
                    chartInstances[psCanvasId] = new Chart(psCanvas, {
                        type: 'bar',
                        data: {
                            labels: chartData.purchased_servers.labels,
                            datasets: [{
                                label: '구매 서버 수량',
                                data: chartData.purchased_servers.data,
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: false },
                                title: { display: false }
                            },
                            scales: {
                                x: { title: { display: true, text: '서버 유형' } },
                                y: { beginAtZero: true, title: { display: true, text: '수량' }, precision: 0 }
                            }
                        }
                    });
                } else { console.error(`Canvas element with ID '${psCanvasId}' not found.`); }
            } else { console.log("No data for purchased_servers chart or data format incorrect."); }

            // 2. 자원 활용률 도넛 차트 (헬퍼 함수 사용)
            function createUtilizationDoughnutChart(canvasId, utilizationData, labelSingular, unit) {
                if (canvasId && utilizationData && typeof utilizationData.used === 'number' && typeof utilizationData.available === 'number') {
                    destroyChartIfExists(canvasId);

                    const used = utilizationData.used;
                    const available = utilizationData.available;
                    const percent = utilizationData.percent || 0;
                    const unused = Math.max(available - used, 0);

                    chartInstances[canvasId] = new Chart(document.getElementById(canvasId), {
                        type: 'doughnut',
                        data: {
                            labels: [`사용됨 (${used}${unit ? ' ' + unit : ''})`, `남음 (${unused}${unit ? ' ' + unit : ''})`],
                            datasets: [{
                                data: [used, unused],
                                backgroundColor: [
                                    'rgba(255, 99, 132, 0.7)',
                                    'rgba(201, 203, 207, 0.4)'
                                ],
                                borderColor: [
                                    'rgba(255, 99, 132, 1)',
                                    'rgba(201, 203, 207, 1)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: true, position: 'bottom' },
                                title: {
                                    display: true,
                                    text: `${labelSingular} 활용률: ${percent}%`
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed;
                                            return `${label}: ${value}${unit ? ' ' + unit : ''}`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                } else { console.error(`Canvas element with ID '${canvasId}' not found or utilizationData invalid.`, utilizationData); }
            }

            if (chartData && chartData.budget_utilization) {
                createUtilizationDoughnutChart('budgetUtilizationChart', chartData.budget_utilization, '예산', '');
            }
            if (chartData && chartData.power_utilization) {
                createUtilizationDoughnutChart('powerUtilizationChart', chartData.power_utilization, '전력', 'kVA');
            }
            if (chartData && chartData.space_utilization) {
                createUtilizationDoughnutChart('spaceUtilizationChart', chartData.space_utilization, '공간', 'sqm');
            }

        } catch (e) {
            console.error("Error parsing chart data or initializing charts:", e);
        }
    });
</script>
{% endblock %}