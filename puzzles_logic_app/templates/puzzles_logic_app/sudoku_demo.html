{% extends "core/base.html" %}
{% load static %}
{% load puzzles_filters %}

{% block title %}Sudoku Demo{% endblock %}

{% block styles %}
    <style>
        .sudoku-grid { border-collapse: collapse; margin: 20px 0; }
        .sudoku-grid td {
            text-align: center; vertical-align: middle;
            border: 1px solid #ccc;
        }
        /* 사이즈별 셀 크기 동적 조절 */
        .size-9 td { width: 40px; height: 40px; font-size: 1.2rem; }
        .size-16 td { width: 30px; height: 30px; font-size: 0.9rem; }
        .size-25 td { width: 25px; height: 25px; font-size: 0.7rem; }

        .sudoku-grid input {
            width: 100%; height: 100%; border: none; text-align: center;
            font-weight: bold; padding: 0; background-color: transparent;
        }
        .sudoku-grid input.original-value { background-color: #e9ecef; color: #343a40; }
        .sudoku-grid input.solved-cell { color: #007bff; }

        /* 동적 보더 스타일 (인라인 스타일로 대체됨) */
        .thick-right { border-right: 2px solid #000 !important; }
        .thick-bottom { border-bottom: 2px solid #000 !important; }
        .thick-top { border-top: 2px solid #000 !important; }
        .thick-left { border-left: 2px solid #000 !important; }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="h2">Sudoku Demo</h1>
    <p>논리 퍼즐 스도쿠를 풀어보는 데모입니다. 원하는 사이즈와 난이도를 선택하고 퍼즐을 풀어보세요.</p>
    <p> 9x9 스도쿠는 요청할 때마다 알고리즘을 통해 새로운 퍼즐을 동적으로 생성합니다. </p>
    <p> 16x16, 25x25 스도쿠는 미리 저장된 정답 그리드에서 난이도에 따라 무작위로 숫자를 제거하여 생성합니다. </p>

    <div class="mb-3 form-inline">
        <div class="form-group mr-2">
            <label for="size_get" class="mr-2">사이즈:</label>
            <select id="size_get" name="size" class="form-control form-control-sm" onchange="submitSettingsForm()">
                {% for size in size_options %}
                    <option value="{{ size }}" {% if size == submitted_size %}selected{% endif %}>{{ size }}x{{ size }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group mr-2">
            <label for="difficulty_get" class="mr-2">난이도:</label>
            <select id="difficulty_get" name="difficulty" class="form-control form-control-sm" onchange="submitSettingsForm()">
                {% for diff in difficulty_options %}
                    <option value="{{ diff.value }}" {% if diff.value == submitted_difficulty %}selected{% endif %}>{{ diff.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group ml-auto">
            <button type="button" class="btn btn-sm btn-info mr-2" id="clearBtn">Clear Board</button>
<!--            <a href="{% url 'puzzles_logic_app:sudoku_demo' %}" class="btn btn-sm btn-warning">Random</a>-->
            <button type="button" class="btn btn-sm btn-success" id="randomizeBtn">새 퍼즐 생성</button>
        </div>
    </div>

    <form method="GET" id="settingsForm" style="display: none;"></form>

    <form method="POST" id="sudokuForm">
        {% csrf_token %}
        <input type="hidden" name="size" value="{{ submitted_size }}">
        <input type="hidden" name="difficulty" value="{{ submitted_difficulty }}">

        <table class="sudoku-grid size-{{ submitted_size }}">
            <tbody>
                {% for r_idx in cell_indices %}
                <tr>
                    {% for c_idx in cell_indices %}
                        {% get_cell_value_tag input_grid r_idx c_idx as initial_val %}

                        {# --- 동적 보더 스타일 적용을 위한 클래스 계산 --- #}
                        {% with r_plus_1=r_idx|add:1 c_plus_1=c_idx|add:1 %}
                        <td class="
                            {% if r_idx == 0 %}thick-top{% endif %}
                            {% if c_idx == 0 %}thick-left{% endif %}
                            {% if r_plus_1|divisibleby:cell_subgrid_size %}thick-bottom{% endif %}
                            {% if c_plus_1|divisibleby:cell_subgrid_size %}thick-right{% endif %}
                        ">
                        {% endwith %}
                            {% if results %}
                                {% get_cell_value_tag results r_idx c_idx as solved_val %}
                                <input type="text" value="{{ solved_val }}"
                                       class="{% if initial_val == 0 %}solved-cell{% else %}original-value{% endif %}" readonly>
                            {% else %}
                                <input type="text" name="cell_{{ r_idx }}_{{ c_idx }}"
                                       value="{% if initial_val != 0 %}{{ initial_val }}{% endif %}" maxlength="2"
                                       class="{% if initial_val != 0 %}original-value{% endif %}">
                            {% endif %}
                        </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <button type="submit" class="btn btn-primary btn-lg mt-3 mb-3">스도쿠 풀기</button>
    </form>

    {% if error_message or success_message %}
    <hr class="my-4">
    <h3 class="mt-4">Solver Result</h3>
    {% endif %}
    {% if error_message %}
        <div class="alert alert-danger" role="alert"><strong>오류:</strong> {{ error_message|safe }}</div>
    {% endif %}
    {% if success_message and not error_message %}
        <div class="alert alert-success" role="alert">{{ success_message }} <small> (처리 시간: {{ processing_time_seconds }} 초)</small></div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
    function submitSettingsForm() {
        const sizeSelect = document.getElementById('size_get');
        const difficultySelect = document.getElementById('difficulty_get');
        window.location.href = `?size=${sizeSelect.value}&difficulty=${difficultySelect.value}`;
    }

    function loadNewPuzzle() {
        const sizeSelect = document.getElementById('size_get');
        const difficultySelect = document.getElementById('difficulty_get');
        // 현재 선택된 값으로 페이지를 다시 로드하여 새 퍼즐을 가져옴
        window.location.href = `?size=${sizeSelect.value}&difficulty=${difficultySelect.value}`;
    }
    document.addEventListener('DOMContentLoaded', function() {
        const randomizeBtn = document.getElementById('randomizeBtn');
        if (randomizeBtn) {
            randomizeBtn.addEventListener('click', loadNewPuzzle);
        }

        const clearBtn = document.getElementById('clearBtn');
        if (clearBtn) {
            clearBtn.addEventListener('click', function() {
                const allCells = document.querySelectorAll('.sudoku-grid input');
                allCells.forEach(cell => {
                    cell.value = '';
                    cell.readOnly = false;
                    cell.classList.remove('original-value', 'solved-cell');
                });
            });
        }

        const allInputs = document.querySelectorAll('.sudoku-grid input');
        allInputs.forEach(input => {
            input.addEventListener('input', function(e) {
                // 숫자가 아닌 문자 제거 (1-9, 10-25 등 두자리수 허용)
                this.value = this.value.replace(/[^0-9]/g, '');
            });
        });
    });
</script>
{% endblock %}