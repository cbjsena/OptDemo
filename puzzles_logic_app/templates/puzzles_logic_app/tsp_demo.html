{% extends "core/base.html" %}
{% load static %}
{% load puzzles_filters %}

{% block title %}Traveling Salesperson Problem Demo{% endblock %}
{% block styles %}
    {# Leaflet.js CSS 파일 추가 #}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <style>
        /* 지도가 표시될 영역의 크기 지정 */
        #map { height: 500px; }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="h2">Traveling Salesperson Problem (TSP) Demo</h1>
    <p>외판원 문제(TSP)는 여러 도시를 한 번씩만 방문하고 출발점으로 돌아오는 가장 짧은 경로를 찾는 문제입니다. 아래에서 방문할 도시를 선택하고 '최단 경로 찾기' 버튼을 눌러주세요.</p>

    <form method="POST" id="tspForm">
        {% csrf_token %}
        <div class="card">
            <div class="card-header">
                <strong>방문할 도시 선택 (2개 이상)</strong>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for city in all_cities %}
                    <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="cities" value="{{ city }}" id="city_{{ forloop.counter0 }}"
                                {% if city in selected_cities %}checked{% endif %}>
                            <label class="form-check-label" for="city_{{ forloop.counter0 }}">
                                {{ city }}
                            </label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-primary btn-lg mt-3 mb-3">최단 경로 찾기</button>
    </form>

    {# --- 결과 메시지 --- #}
    {% if error_message or success_message %}
    <hr class="my-4">
    <h3 class="mt-4">Optimization Result</h3>
    {% endif %}
    {% if error_message %}
        <div class="alert alert-danger" role="alert"><strong>오류:</strong> {{ error_message }}</div>
    {% endif %}
    {% if success_message and not error_message %}
        <div class="alert alert-success" role="alert">{{ success_message }}</div>
    {% endif %}

     {# --- 결과 상세 --- #}
    {% if results %}
    <div class="row mt-4">
        {# 텍스트 결과 표시 영역 #}
        <div class="col-md-5">
             <div class="card">
                <div class="card-body">
                    <h5 class="card-title">최적 경로</h5>
                    <p class="card-text" style="font-size: 1.1rem;">
                        <strong>{{ results.tour_cities }}</strong>
                    </p>
                    <hr>
                    <p class="mb-0"><strong>총 이동 거리:</strong> {{ results.total_distance }} km</p>
                    <p class="mb-0 text-muted"><small>처리 시간: {{ processing_time_seconds }} 초</small></p>
                </div>
            </div>
        </div>
        {# 지도 표시 영역 #}
        <div class="col-md-7">
            <div id="map" class="border rounded"></div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
{# Leaflet.js 스크립트 파일 추가 #}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

<script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>

{# 결과가 있을 때만 지도 생성 스크립트 실행 #}
{% if results %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Django 컨텍스트 변수를 Javascript 변수로 변환
        const tourData = {{ results.tour_cities_data|safe }};
        const coordinates = tourData.map(city => [city.lat, city.lon]);

        // 2. 지도 초기화 (한국 중심 좌표)
        const map = L.map('map').setView([36.5, 127.5], 7);

        // 3. 배경 지도 타일 추가 (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // 4. 경로(Polyline) 그리기
        const polyline = L.polyline(coordinates, {color: 'blue'}).addTo(map);

        // 경로 위에 화살표 데코레이터 추가
        const decorator = L.polylineDecorator(polyline, {
            patterns: [
                {
<!--                    offset: '50%', // 각 선분의 중간에 화살표 표시-->
                    offset: 25,       // 경로 시작부터 25px 떨어진 곳에서 첫 화살표 시작
                    repeat: 150,      // 150px 간격으로 화살표 반복
                    symbol: L.Symbol.arrowHead({
                        pixelSize: 12,
                        pathOptions: {
                            color: 'red',
                            fillOpacity: 1,
                            weight: 0
                        }
                    })
                }
            ]
        }).addTo(map);

        // 5. 각 도시에 마커(핀)와 툴팁 추가
        tourData.forEach((city, index) => {
            L.marker([city.lat, city.lon])
                .addTo(map)
                .bindTooltip(`<b>${index}. ${city.name}</b>`, { permanent: true, direction: 'right' });
        });

        // 6. 모든 마커와 경로가 보이도록 지도 뷰 자동 조절
        map.fitBounds(polyline.getBounds().pad(0.1));
    });
</script>
{% endif %}
{% endblock %}