{% extends "core/base.html" %}
{% load static %}
{% load routing_filters %}

{% block title %}VRP Demo - Graphical Input{% endblock %}

{% block styles %}
<style>
    #vrpCanvasInput {
        border: 1px solid #007bff;
        cursor: crosshair;
        margin-bottom: 10px;
        background-color: #f8f9fa;
    }
    #canvasInstructions {
        font-weight: bold;
        color: #0056b3;
        margin-bottom: 10px;
        min-height: 24px;
    }
    .location-list {
        font-size: 0.9em;
        max-height: 150px;
        overflow-y: auto;
        border: 1px solid #eee;
        padding: 5px;
        background-color: #fff;
    }
    .chart-container {
        width: 100%;
        max-width: 700px;
        margin: 20px auto;
        height: 450px;
        border: 1px
        solid #ddd;
        padding:10px;
    }
    .highlight-box {
        background-color: #e9f7fd;
        border-left: 5px solid #007bff;
        padding: 15px;
        margin: 20px 0;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Vehicle Routing Problem (VRP) Demo - Graphical Input</h1>
    </div>
    <p>ì•„ë˜ ì˜ì—­ì„ í´ë¦­í•˜ì—¬ ì°¨ê³ ì§€(Depot)ì™€ ê³ ê° ìœ„ì¹˜ë¥¼ ì§€ì •í•œ í›„, ì°¨ëŸ‰ ìˆ˜ë¥¼ ì„¤ì •í•˜ê³  ìµœì  ê²½ë¡œë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.</p>

    <form method="GET" class="mb-3 form-inline">
        <div class="form-group mr-2">
            <label for="num_customers_to_show" class="mr-2">ê³ ê° ìˆ˜ (1-10):</label>
            <select name="num_customers_to_show" id="num_customers_to_show" class="form-control form-control-sm" onchange="this.form.submit()">
                {% for i in num_customers_options %}
                    <option value="{{ i }}" {% if i == submitted_num_customers %}selected{% endif %}>{{ i }}ëª…</option>
                {% endfor %}
            </select>
            (ê³ ê° ìˆ˜ë‚˜ ì°¨ëŸ‰ ìˆ˜ë¥¼ ë³€ê²½í•˜ë©´ ì‘ì—… ì •ë³´ê°€ ì´ˆê¸°í™” ë©ë‹ˆë‹¤.)
        </div>
        <div class="form-group mr-2">
            <label for="num_vehicles_to_show" class="mr-2">ì°¨ëŸ‰ ìˆ˜ (1-5):</label>
            <select name="num_vehicles_to_show" id="num_vehicles_to_show" class="form-control form-control-sm" onchange="this.form.submit()">
                {% for i in num_vehicles_options %}
                    <option value="{{ i }}" {% if i == submitted_num_vehicles %}selected{% endif %}>{{ i }}ëŒ€</option>
                {% endfor %}
            </select>
        </div>
        <noscript><button type="submit" class="btn btn-sm btn-secondary">ì„¤ì • ì ìš©</button></noscript>
    </form>

    <form method="POST" id="vrpForm">
        {% csrf_token %}
        <input type="hidden" name="problem_type" value="VRP" id="problem_type">
        <input type="hidden" name="num_customers" value="{{ submitted_num_customers }}" id="form_num_customers">
        <input type="hidden" name="num_vehicles" value="{{ submitted_num_vehicles }}" id="form_num_vehicles">

        <div class="form-section">
            <h4>1. ìœ„ì¹˜ ì§€ì • (ì°¨ê³ ì§€ 1ê°œ, ê³ ê° {{ submitted_num_customers }}ëª…, ì°¨ëŸ‰ {{submitted_num_vehicles}}ëŒ€)</h4>
            <p>ìµœì´ˆ ì¢Œì¸¡ ìƒë‹¨ íŒŒë€ìƒ‰ìœ¼ë¡œ ì´ˆê¸°í™” ë©ë‹ˆë‹¤. ì°¨ê³ ì§€ ìœ„ì¹˜ë¥¼ ë³€ê²½í•˜ë ¤ë©´ ì•„ë˜ ìœ„ì¹˜ ì´ˆê¸°í™” ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
            <p id="canvasInstructions">ë¨¼ì € ì°¨ê³ ì§€(Depot) ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”.</p>
            <canvas id="vrpCanvasInput" width="600" height="400"></canvas>
            <button type="button" class="btn btn-sm btn-warning mb-2" id="resetLocationsBtn">ìœ„ì¹˜ ì´ˆê¸°í™”</button>

            <h5>ì§€ì •ëœ ìœ„ì¹˜:</h5>
            <div id="locationsDisplay" class="location-list">
                <p>ì•„ì§ ì§€ì •ëœ ìœ„ì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>

            <input type="hidden" name="depot_x" id="hidden_depot_x" value="{{ form_data.depot_x|default_if_none:'0' }}">
            <input type="hidden" name="depot_y" id="hidden_depot_y" value="{{ form_data.depot_y|default_if_none:'0' }}">

            {% for i in submitted_num_customers|get_range %}
                {% make_key 'cust' i 'id' as key_name %}
                <input type="hidden" name="cust_{{ i }}_id" id="hidden_cust_{{ i }}_id"
                       value="{{ form_data|get_item_simple:key_name }}">
                {% make_key 'cust' i 'x' as key_name %}
                <input type="hidden" name="cust_{{ i }}_x" id="hidden_cust_{{ i }}_x"
                       value="{{ form_data|get_item_simple:key_name }}">
                {% make_key 'cust' i 'y' as key_name %}
                <input type="hidden" name="cust_{{ i }}_y" id="hidden_cust_{{ i }}_y"
                       value="{{ form_data|get_item_simple:key_name }}">
                {% make_key 'cust' i 'demand' as key_name %}
                <input type="hidden" name="cust_{{ i }}_demand" id="hidden_cust_{{ i }}_demnad"
                       value="{{ form_data|get_item_simple:key_name }}">
            {% endfor %}
        </div>

        <button type="submit" class="btn btn-primary btn-lg mt-3 mb-3">ìµœì  ê²½ë¡œ ê³„ì‚° ì‹¤í–‰</button>
    </form>

    {# 1. ê²°ê³¼ ë©”ì„¸ì§€ #}
    {% if success_save_message%}
        <div class="alert alert-success" role="alert">{{ success_save_message }}</div>
    {% endif %}
    {% if opt_results is not None or error_message or success_message %}
    <hr class="my-4">
    <h3 class="mt-4">Optimization Results ({{ active_submenu }})</h3>
    {% endif %}
    {% if error_message %}
        <div class="alert alert-danger" role="alert"><strong>ì˜¤ë¥˜:</strong> {{ error_message }}</div>
    {% endif %}
    {% if success_message and not error_message %}
        <div class="alert alert-success" role="alert">{{ success_message }}</div>
    {% endif %}

    {# 2. ê²°ê³¼ ìš”ì•½ ë° ì‹œê°í™” #}
    {% if opt_results %}
    <div class="card mt-4">
        <div class="card-header"><strong>ê²°ê³¼ ìš”ì•½</strong></div>
        <div class="card-body">
            <p><strong>ì´ ìš´í–‰ ê±°ë¦¬:</strong> {{ opt_results.total_distance|floatformat:2 }}</p>
            <p><strong>ì‚¬ìš©ëœ ì°¨ëŸ‰ ìˆ˜:</strong> {{ opt_results.routes|length }} / {{ submitted_num_vehicles }}</p>
            {% if opt_results.dropped_nodes %}
                <p class="text-danger"><strong>ë°©ë¬¸ ì‹¤íŒ¨ ê³ ê° ìˆ˜:</strong> {{ opt_results.dropped_nodes|length }}</p>
            {% endif %}
            <p><small>ì²˜ë¦¬ ì‹œê°„: {{ processing_time_seconds }} ì´ˆ</small></p>
        </div>
    </div>

    {% if opt_results.routes %}
    <div class="card mt-3">
        <div class="card-header"><strong>ì°¨ëŸ‰ë³„ ìµœì  ê²½ë¡œ</strong></div>
        <div class="table-responsive">
            <table class="table table-sm table-hover results-table mb-0">
                <thead class="thead-light">
                    <tr>
                        <th>ì°¨ëŸ‰ ID</th>
                        <th>ê²½ë¡œ (ë…¸ë“œ ì¸ë±ìŠ¤)</th>
                        <th>ê²½ë¡œ (ê³ ê° ID ìˆœì„œ)</th>
                        <th>ì°¨ëŸ‰ë³„ ì´ë™ ê±°ë¦¬</th>
                    </tr>
                </thead>
                <tbody>
                    {% for route in opt_results.routes %}
                    <tr>
                        <td>ì°¨ëŸ‰ {{ route.vehicle_id|add:1 }}</td>
                        <td class="route-path">
                            {% for node_index in route.route_nodes %}
                                {{ node_index }}{% if not forloop.last %} &rarr; {% endif %}
                            {% endfor %}
                        </td>
                        <td class="route-path">
                            {% for loc_coord_tuple in route.route_locations %} {# ë·°ì—ì„œ íŠœí”Œë¡œ ì „ë‹¬ë¨ #}
                                {% with x_coord=loc_coord_tuple.0 y_coord=loc_coord_tuple.1 %}
                                    {% if forloop.first or forloop.last %}
                                        Depot
                                    {% else %}
                                        {% for cust_idx in submitted_num_customers|get_range %}
                                            {% with hidden_x_id="hidden_cust_"|add:cust_idx|stringformat:"s"|add:"_x" hidden_y_id="hidden_cust_"|add:cust_idx|stringformat:"s"|add:"_y" hidden_id_id="hidden_cust_"|add:cust_idx|stringformat:"s"|add:"_id" %}
                                                {% if form_data|get_item_simple:hidden_x_id|stringformat:"s" == x_coord|stringformat:"s" and form_data|get_item_simple:hidden_y_id|stringformat:"s" == y_coord|stringformat:"s" %}
                                                    {{ form_data|get_item_simple:hidden_id_id }}
                                                {% endif %}
                                            {% endwith %}
                                        {% endfor %}
                                    {% endif %}
                                    ({{ x_coord|floatformat }},{{ y_coord|floatformat }}){% if not forloop.last %} &rarr; {% endif %}
                                {% endwith %}
                            {% endfor %}
                        </td>
                        <td>{{ route.distance|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {% if plot_data %}
    <div class="card mt-3">
        <div class="card-header"><strong>ê²½ë¡œ ì‹œê°í™” (VRP)</strong></div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="vrpRouteChart"></canvas>
            </div>
        </div>
    </div>
    {% endif %}

    {% if opt_results %}
    <div class="highlight-box">
        <h4>íŠ¹ë³„ ì¼€ì´ìŠ¤: "ì œí•œì´ ì—†ëŠ”" VRP ë¬¸ì œì™€ ì°¨ëŸ‰ ìˆ˜ ğŸšš</h4>
        <p>
            ë§Œì•½ VRPì—ì„œ ì£¼ìš” ëª©í‘œê°€ ì˜¤ì§ ì´ ìš´í–‰ ê±°ë¦¬ ìµœì†Œí™”ì´ê³ , ì°¨ëŸ‰ ìš©ëŸ‰, ìš´í–‰ ì‹œê°„, ê³ ê° ë°©ë¬¸ ì‹œê°„ ì°½ ë“±ì— ëŒ€í•œ ì œí•œì´ ì „í˜€ ì—†ë‹¤ë©´, ì´ë¡ ì ìœ¼ë¡œëŠ” ë‹¨ í•œ ëŒ€ì˜ ì°¨ëŸ‰ìœ¼ë¡œ ëª¨ë“  ê³ ê°ì„ ë°©ë¬¸í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì§§ì€ ì´ ìš´í–‰ ê±°ë¦¬ë¥¼ ë‹¬ì„±í•©ë‹ˆë‹¤.
        </p>
        <p>
            ì—¬ê¸°ì„œ "ì œí•œì´ ì—†ë‹¤"ëŠ” ê²ƒì€ ë‹¤ìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤:
            <ul>
                <li>ì°¨ëŸ‰ ìš©ëŸ‰ ë¬´ì œí•œ: í•œ ì°¨ëŸ‰ì— ëª¨ë“  ê³ ê°ì˜ ë¬¼í’ˆì„ ì‹¤ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                <li>ìš´í–‰ ê±°ë¦¬/ì‹œê°„ ë¬´ì œí•œ: ì°¨ëŸ‰ì´ ë¬´í•œì • ìš´í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                <li>ì‹œê°„ ì°½ ì œì•½ ì—†ìŒ: ì–¸ì œë“  ê³ ê°ì„ ë°©ë¬¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
            </ul>
        </p>

        <h4>ì™œ í•œ ëŒ€ì˜ ì°¨ëŸ‰ì´ ìµœì ì¼ê¹Œìš”? (ê¸°ë³¸ ì›ë¦¬: ì™•ë³µ ì´ë™ì˜ ë¹„íš¨ìœ¨ì„±)</h4>
        <p>
            ê° ì°¨ëŸ‰ì€ ë¬¼ë¥˜ì„¼í„°(Depot)ì—ì„œ ì¶œë°œí•˜ì—¬ ê³ ê°ë“¤ì„ ë°©ë¬¸ í›„ ë‹¤ì‹œ ë¬¼ë¥˜ì„¼í„°ë¡œ ëŒì•„ì™€ì•¼ í•©ë‹ˆë‹¤. ì—¬ëŸ¬ ëŒ€ì˜ ì°¨ëŸ‰ì„ ì‚¬ìš©í•˜ë©´, ê° ì°¨ëŸ‰ë§ˆë‹¤ ë¬¼ë¥˜ì„¼í„°ë¥¼ ì˜¤ê°€ëŠ” ê²½ë¡œê°€ í•„ì—°ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤.
        </p>
        <p><strong>ë‹¨ì¼ ì°¨ëŸ‰ì˜ ê²½ìš° (ì™¸íŒì› ë¬¸ì œ, TSPì™€ ìœ ì‚¬):</strong></p>
        <p>
            ì°¨ëŸ‰ í•œ ëŒ€ëŠ” ë¬¼ë¥˜ì„¼í„°ì—ì„œ ì¶œë°œí•´ ëª¨ë“  ê³ ê°ì„ ìµœì ì˜ ìˆœì„œë¡œ ë°©ë¬¸í•˜ê³  ë‹¤ì‹œ ë¬¼ë¥˜ì„¼í„°ë¡œ ëŒì•„ì˜¤ëŠ”, í•˜ë‚˜ì˜ ê°€ì¥ ì§§ì€ ìˆœíšŒ ê²½ë¡œë¥¼ ì°¾ê²Œ ë©ë‹ˆë‹¤.
            <br>ê²½ë¡œ: D &rarr; C1 &rarr; C2 &rarr; C3 &rarr; D
            <br>ì´ ì´ë™ ê±°ë¦¬ = d(D,C1) + d(C1,C2) + d(C2,C3) + d(C3,D)
        </p>
        <p><strong>ë‘ ëŒ€ì˜ ì°¨ëŸ‰ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš° (ì˜ˆì‹œ):</strong></p>
        <p>
            ê³ ê° C1ì€ ì°¨ëŸ‰1ì´, ê³ ê° C2ì™€ C3ëŠ” ì°¨ëŸ‰2ê°€ ë‹´ë‹¹í•œë‹¤ê³  ê°€ì •í•´ ë´…ì‹œë‹¤.
            <br>ì°¨ëŸ‰1 ê²½ë¡œ: D &rarr; C1 &rarr; D (ì´ë™ ê±°ë¦¬1 = d(D,C1) + d(C1,D))
            <br>ì°¨ëŸ‰2 ê²½ë¡œ: D &rarr; C2 &rarr; C3 &rarr; D (ì´ë™ ê±°ë¦¬2 = d(D,C2) + d(C2,C3) + d(C3,D))
            <br>ë‘ ì°¨ëŸ‰ì˜ ì´ ì´ë™ ê±°ë¦¬ = ì´ë™ ê±°ë¦¬1 + ì´ë™ ê±°ë¦¬2
        </p>
        <h4>ë¹„êµ</h4>
        <p>
            ì¼ë°˜ì ìœ¼ë¡œ (íŠ¹íˆ, ì§í–‰ ê±°ë¦¬ê°€ ê²½ìœ  ê±°ë¦¬ë³´ë‹¤ ì§§ê±°ë‚˜ ê°™ì€ ì‚¼ê° ë¶€ë“±ì‹ì´ ì„±ë¦½í•˜ëŠ” ê²½ìš°), ê³ ê° C1ì—ì„œ C2ë¡œ ì§ì ‘ ì´ë™í•˜ëŠ” ê±°ë¦¬ `d(C1,C2)`ëŠ” C1ì—ì„œ ë¬¼ë¥˜ì„¼í„°ë¡œ ëŒì•„ê°”ë‹¤ê°€(`d(C1,D)`) ë‹¤ì‹œ ë¬¼ë¥˜ì„¼í„°ì—ì„œ C2ë¡œ ê°€ëŠ” ê±°ë¦¬(`d(D,C2)`)ì˜ í•©ë³´ë‹¤ ì§§ê±°ë‚˜ ê°™ìŠµë‹ˆë‹¤. ì¦‰, `d(C1,C2) &le; d(C1,D) + d(D,C2)` ì…ë‹ˆë‹¤.
        </p>
        <p>
            ë”°ë¼ì„œ ì—¬ëŸ¬ ì°¨ëŸ‰ì„ ì‚¬ìš©í•˜ë©´ ê° ì°¨ëŸ‰ì´ ë¬¼ë¥˜ì„¼í„°ë¡œ ë³µê·€í•˜ëŠ” ë° í•„ìš”í•œ "ì¶”ê°€ì ì¸ ì™•ë³µ ì´ë™" ë•Œë¬¸ì— ì´ ì´ë™ ê±°ë¦¬ê°€ ë‹¨ì¼ ì°¨ëŸ‰ì„ ì‚¬ìš©í•  ë•Œë³´ë‹¤ ê¸¸ì–´ì§€ëŠ” ê²½í–¥ì´ ìˆìŠµë‹ˆë‹¤.
        </p>
        <h4>ê²°ë¡ </h4>
        <p>
            ë§Œì•½ VRPì˜ ìœ ì¼í•œ ëª©í‘œê°€ ì´ ìš´í–‰ ê±°ë¦¬ ìµœì†Œí™”ì´ê³  ë‹¤ë¥¸ ì œì•½(ìš©ëŸ‰, ì‹œê°„ ë“±)ì´ ì—†ë‹¤ë©´, í•œ ëŒ€ì˜ ì°¨ëŸ‰ìœ¼ë¡œ ëª¨ë“  ê³ ê°ì„ ë°©ë¬¸í•˜ëŠ” ê²ƒì´ ì´ë¡ ì ìœ¼ë¡œ ê°€ì¥ íš¨ìœ¨ì ì…ë‹ˆë‹¤.
        </p>
        <p>
            í•˜ì§€ë§Œ ì‹¤ì œ ìƒí™©ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë‹¤ë¥¸ ê³ ë ¤ ì‚¬í•­ ë•Œë¬¸ì— ì—¬ëŸ¬ ì°¨ëŸ‰ì´ í•„ìš”í•˜ê±°ë‚˜ ë” íš¨ìœ¨ì ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
            <ul>
                <li><strong>ì‘ì—… ì™„ë£Œ ì‹œê°„ ìµœì†Œí™”:</strong> ëª¨ë“  ë°°ì†¡ì„ ê°€ëŠ¥í•œ í•œ ë¹¨ë¦¬ ëë‚´ë ¤ë©´ ì—¬ëŸ¬ ì°¨ëŸ‰ì„ ë™ì‹œì— ìš´ì˜í•˜ëŠ” ê²ƒì´ ìœ ë¦¬í•©ë‹ˆë‹¤. ì´ ì´ë™ ê±°ë¦¬ëŠ” ëŠ˜ì–´ë‚  ìˆ˜ ìˆì§€ë§Œ, ì „ì²´ ì‘ì—… ì‹œê°„ì€ ë‹¨ì¶•ë©ë‹ˆë‹¤.</li>
                <li><strong>ì°¨ëŸ‰ ìš©ëŸ‰ ë° ìš´í–‰ ì‹œê°„ ì œì•½:</strong> ì‹¤ì œ ì°¨ëŸ‰ì€ ì‹¤ì„ ìˆ˜ ìˆëŠ” ë¬¼í’ˆì˜ ì–‘ì´ë‚˜ í•˜ë£¨ ë™ì•ˆ ìš´í–‰í•  ìˆ˜ ìˆëŠ” ì‹œê°„/ê±°ë¦¬ì— í•œê³„ê°€ ìˆìŠµë‹ˆë‹¤. ì´ ê²½ìš° ì—¬ëŸ¬ ì°¨ëŸ‰ì´ í•„ìˆ˜ì ì…ë‹ˆë‹¤.</li>
                <li><strong>ê³ ê° ë°©ë¬¸ ì‹œê°„ ì°½:</strong> ê³ ê°ì´ íŠ¹ì • ì‹œê°„ëŒ€ì—ë§Œ ì„œë¹„ìŠ¤ë¥¼ ë°›ì„ ìˆ˜ ìˆë‹¤ë©´, ì´ë¥¼ ë§ì¶”ê¸° ìœ„í•´ ì—¬ëŸ¬ ì°¨ëŸ‰ì´ ê°ê¸° ë‹¤ë¥¸ ê²½ë¡œë¥¼ ìš´í–‰í•´ì•¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
            </ul>
        </p>
    </div>
    {% endif %}

    {% elif request.method == 'POST' and not error_message and not success_message %}
        <p class="text-muted mt-3"><em>ìµœì í™” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ì…ë ¥ê°’ì„ í™•ì¸í•˜ê±°ë‚˜, ì†”ë²„ê°€ í•´ë¥¼ ì°¾ì§€ ëª»í–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</em></p>
    {% endif %}

</div>
{% endblock %}

{% block scripts %}
<script>
    // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ê´€ë¦¬ëŠ” ì´ì „ê³¼ ë™ì¼
    var chartInstances = window.chartInstances || {}; // ì „ì—­ ë˜ëŠ” í˜ì´ì§€ ìŠ¤ì½”í”„ì— ì´ë¯¸ ìˆë‹¤ë©´ ì¬ì‚¬ìš©
    function destroyChartIfExists(chartId) {
        if (chartInstances[chartId]) {
            chartInstances[chartId].destroy();
            delete chartInstances[chartId];
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        console.log("VRP Demo page with graphical input loaded.");

        const canvas = document.getElementById('vrpCanvasInput');
        const ctx = canvas.getContext('2d');
        const instructions = document.getElementById('canvasInstructions');
        const locationsDisplay = document.getElementById('locationsDisplay');
        const resetBtn = document.getElementById('resetLocationsBtn');

        const depotHiddenX = document.getElementById('hidden_depot_x');
        const depotHiddenY = document.getElementById('hidden_depot_y');

        const numCustomers = parseInt(document.getElementById('form_num_customers').value);
        let customerHiddenX = [];
        let customerHiddenY = [];
        let customerHiddenId = [];

        for (let i = 0; i < numCustomers; i++) {
            customerHiddenX.push(document.getElementById(`hidden_cust_${i}_x`));
            customerHiddenY.push(document.getElementById(`hidden_cust_${i}_y`));
            customerHiddenId.push(document.getElementById(`hidden_cust_${i}_id`)); // ID í•„ë“œë„ ê°€ì ¸ì˜´
        }

        let depot = null; // {x, y}
        let customers = []; // Array of {id, x, y}
        let currentCustomerIndex = 0;
        let placingDepot = true;

        // ì´ˆê¸°ê°’ìœ¼ë¡œ ìˆ¨ê²¨ì§„ í•„ë“œ ì±„ìš°ê¸° (GET ìš”ì²­ ì‹œ ë·°ì—ì„œ ì„¤ì •í•œ ê°’)
        function loadInitialValues() {
            if (depotHiddenX.value && depotHiddenY.value) {
                depot = { x: parseFloat(depotHiddenX.value), y: parseFloat(depotHiddenY.value) };
            }
            for (let i = 0; i < numCustomers; i++) {
                if (customerHiddenX[i] && customerHiddenY[i] && customerHiddenX[i].value && customerHiddenY[i].value) {
                    customers[i] = {
                        id: customerHiddenId[i].value || `C${i+1}`, // IDê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’
                        x: parseFloat(customerHiddenX[i].value),
                        y: parseFloat(customerHiddenY[i].value)
                    };
                } else {
                    customers[i] = null; // ì•„ì§ ì§€ì •ë˜ì§€ ì•ŠìŒ
                }
            }
            // ëª¨ë“  ê³ ê°ì´ ì§€ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì—¬ ë‹¤ìŒ ë‹¨ê³„ ê²°ì •
            if (depot) placingDepot = false;
            currentCustomerIndex = customers.findIndex(c => c === null);
            if (currentCustomerIndex === -1 && depot) { // ëª¨ë“  ê³ ê° + ì°¨ê³ ì§€ ì§€ì •ë¨
                 currentCustomerIndex = numCustomers; // ë‹¤ìŒ í´ë¦­ì€ ë¬´ì‹œí•˜ë„ë¡
            } else if (currentCustomerIndex === -1 && !depot) { // ê³ ê°ì€ ë‹¤ ì§€ì •ë˜ì—ˆëŠ”ë° ì°¨ê³ ì§€ê°€ ì—†ìœ¼ë©´ ë‹¤ì‹œ ì°¨ê³ ì§€ë¶€í„°
                placingDepot = true;
                currentCustomerIndex = 0;
            }
            updateInstructionsAndDisplay();
            redrawCanvas();
        }


        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // ì°¨ê³ ì§€ ê·¸ë¦¬ê¸°
            if (depot) {
                ctx.fillStyle = 'blue';
                ctx.beginPath();
                ctx.arc(depot.x, depot.y, 7, 0, 2 * Math.PI); // ë” í° ì›
                ctx.fill();
                ctx.fillStyle = 'white';
                ctx.fillText('D', depot.x - 4, depot.y + 4);
            }
            // ê³ ê° ìœ„ì¹˜ ê·¸ë¦¬ê¸°
            customers.forEach((cust, index) => {
                if (cust) {
                    ctx.fillStyle = 'red';
                    ctx.beginPath();
                    ctx.arc(cust.x, cust.y, 5, 0, 2 * Math.PI);
                    ctx.fill();
                    ctx.fillStyle = 'black';
                    ctx.fillText(cust.id || `C${index+1}`, cust.x + 8, cust.y + 4);
                }
            });
        }

        function updateInstructionsAndDisplay() {
            let html = '';
            if (depot) {
                html += `<p><strong>Depot:</strong> (${depot.x.toFixed(1)}, ${depot.y.toFixed(1)})</p>`;
            } else {
                 html += `<p>Depot: Not set</p>`;
            }

            html += "<h6>Customers:</h6>";
            let allSet = depot !== null;
            for (let i = 0; i < numCustomers; i++) {
                if (customers[i]) {
                    html += `<p><strong>${customers[i].id}:</strong> (${customers[i].x.toFixed(1)}, ${customers[i].y.toFixed(1)})</p>`;
                } else {
                    html += `<p>Customer ${i+1}: Not set</p>`;
                    allSet = false; // ì•„ì§ ì„¤ì • ì•ˆ ëœ ê³ ê° ìˆìŒ
                }
            }
            locationsDisplay.innerHTML = html;

            if (placingDepot) {
                instructions.textContent = 'ì°¨ê³ ì§€(Depot) ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”.';
            } else if (currentCustomerIndex < numCustomers) {
                instructions.textContent = `ê³ ê° ${currentCustomerIndex + 1} ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”. (${numCustomers - currentCustomerIndex}ëª… ë‚¨ìŒ)`;
            } else {
                instructions.textContent = 'ëª¨ë“  ìœ„ì¹˜ê°€ ì§€ì •ë˜ì—ˆìŠµë‹ˆë‹¤. "ìµœì  ê²½ë¡œ ê³„ì‚° ì‹¤í–‰" ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.';
            }
        }

        canvas.addEventListener('click', function(event) {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            if (placingDepot) {
                depot = { x: x, y: y };
                depotHiddenX.value = x.toFixed(2); // ì†Œìˆ˜ì  2ìë¦¬ë¡œ ì €ì¥
                depotHiddenY.value = y.toFixed(2);
                placingDepot = false;
                currentCustomerIndex = customers.findIndex(c => c === null); // ë‹¤ìŒ ê³ ê° ì°¾ê¸°
                 if (currentCustomerIndex === -1) currentCustomerIndex = 0; // ëª¨ë“  ê³ ê°ì´ nullì´ë©´ ì²˜ìŒë¶€í„°
            } else if (currentCustomerIndex < numCustomers) {
                const custId = customerHiddenId[currentCustomerIndex] ? customerHiddenId[currentCustomerIndex].value : `C${currentCustomerIndex+1}`;
                customers[currentCustomerIndex] = { id: custId, x: x, y: y };
                if (customerHiddenX[currentCustomerIndex]) customerHiddenX[currentCustomerIndex].value = x.toFixed(2);
                if (customerHiddenY[currentCustomerIndex]) customerHiddenY[currentCustomerIndex].value = y.toFixed(2);

                currentCustomerIndex = customers.findIndex(c => c === null);
                if (currentCustomerIndex === -1) { // ëª¨ë“  ê³ ê°ì´ ì§€ì •ë¨
                    currentCustomerIndex = numCustomers; // ë” ì´ìƒ ê³ ê°ì„ ë°›ì§€ ì•ŠìŒ
                }
            } else {
                // ëª¨ë“  ìœ„ì¹˜ ì§€ì • ì™„ë£Œ
                console.log("All locations set.");
            }
            updateInstructionsAndDisplay();
            redrawCanvas();
        });

        resetBtn.addEventListener('click', function() {
            depot = null;
            customers = new Array(numCustomers).fill(null); // ê³ ê° ë°°ì—´ ì´ˆê¸°í™”
            depotHiddenX.value = '';
            depotHiddenY.value = '';
            for (let i = 0; i < numCustomers; i++) {
                if(customerHiddenX[i]) customerHiddenX[i].value = '';
                if(customerHiddenY[i]) customerHiddenY[i].value = '';
                // IDëŠ” ìœ ì§€í•˜ê±°ë‚˜, ì—¬ê¸°ì„œ ë‹¤ì‹œ ì„¤ì •í•  ìˆ˜ ìˆìŒ
                // if(customerHiddenId[i]) customerHiddenId[i].value = `C${i+1}`;
            }
            placingDepot = true;
            currentCustomerIndex = 0;
            updateInstructionsAndDisplay();
            redrawCanvas();
            console.log("Locations reset.");
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°ê°’ìœ¼ë¡œ ìº”ë²„ìŠ¤ ë° ìƒíƒœ ì—…ë°ì´íŠ¸
        loadInitialValues();


        // --- ê²°ê³¼ ì°¨íŠ¸ ê·¸ë¦¬ê¸° ë¡œì§ (ì´ì „ ë‹µë³€ê³¼ ìœ ì‚¬í•˜ê²Œ ìœ ì§€) ---
        const plotDataJson = '{{ plot_data|safe|default_if_none:"{}" }}';
        try {
            const plotData = JSON.parse(plotDataJson);
            if (plotData && plotData.locations && plotData.routes) {
                const vrpCtxElement = document.getElementById('vrpRouteChart');
                if (vrpCtxElement) {
                    destroyChartIfExists('vrpRouteChart'); // ê¸°ì¡´ ì°¨íŠ¸ íŒŒê´´

                    const datasets = [];
                    const customerPoints = plotData.locations.slice(1).map(loc => ({x: loc.x, y: loc.y}));
                    datasets.push({
                        type: 'scatter', label: 'ê³ ê° ìœ„ì¹˜', data: customerPoints,
                        backgroundColor: 'rgba(255, 99, 132, 0.8)', pointRadius: 6
                    });

                    if (plotData.locations.length > 0) {
                        datasets.push({
                            type: 'scatter', label: 'ì°¨ê³ ì§€ (Depot)',
                            data: [{x: plotData.locations[0].x, y: plotData.locations[0].y}],
                            backgroundColor: 'rgba(54, 162, 235, 0.8)', pointRadius: 8, pointStyle: 'rectRot'
                        });
                    }

                    const routeColors = ['rgba(75, 192, 192, 0.8)', 'rgba(255, 159, 64, 0.8)', 'rgba(153, 102, 255, 0.8)', 'rgba(255, 205, 86, 0.8)', 'rgba(50, 205, 50, 0.8)'];
                    plotData.routes.forEach((route, index) => {
                        datasets.push({
                            type: 'line', label: `ì°¨ëŸ‰ ${route.vehicle_id + 1} ê²½ë¡œ`,
                            data: route.path_coords.map(coord => ({x: coord[0], y: coord[1]})),
                            borderColor: routeColors[index % routeColors.length], borderWidth: 2.5, fill: false, tension: 0
                        });
                    });

                    chartInstances['vrpRouteChart'] = new Chart(vrpCtxElement, { // ì¸ìŠ¤í„´ìŠ¤ ì €ì¥
                        data: { datasets: datasets },
                        options: {
                            responsive: true, maintainAspectRatio: true,
                            scales: { x: { type: 'linear', position: 'bottom', title: { display: true, text: 'X ì¢Œí‘œ' }},
                                      y: { type: 'linear', title: { display: true, text: 'Y ì¢Œí‘œ' }}},
                            plugins: { title: { display: true, text: 'VRP ê²½ë¡œ ì‹œê°í™”' }, legend: { position: 'top' }}
                        }
                    });
                }
            }
        } catch (e) {
            console.error("Error parsing VRP plot data or initializing chart:", e);
        }
    });
</script>
{% endblock %}