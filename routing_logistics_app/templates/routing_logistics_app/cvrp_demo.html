{% extends "core/base.html" %}
{% load static %}
{% load routing_filters %}

{% block title %}CVRP Demo - Capacitated Vehicle Routing Problem{% endblock %}

{% block styles %}
<style>
    #vrpCanvasInput {
        border: 1px solid #007bff;
        cursor: crosshair;
        margin-bottom: 10px;
        background-color: #f8f9fa;
    }
    #canvasInstructions {
        font-weight: bold;
        color: #0056b3;
        margin-bottom: 10px;
        min-height: 24px;
    }
    .location-list {
        font-size: 0.9em;
        max-height: 150px;
        overflow-y: auto;
        border: 1px solid #eee;
        padding: 5px;
        background-color: #fff;
    }
    .chart-container {
        width: 100%;
        max-width: 700px;
        margin: 20px auto;
        height: 450px;
        border: 1px
        solid #ddd;
        padding:10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Capacitated VRP (CVRP) Demo - Graphical Input</h1>
    </div>
    <p>차고지, 고객 위치, 수요량, 차량 수 및 용량을 입력하여 총 이동 거리를 최소화하는 최적 차량 경로를 계산합니다.</p>

    <form method="GET" class="mb-3 form-inline">
        <div class="form-group mr-2">
            <label for="num_customers_to_show" class="mr-2">고객 수 (1-10):</label>
            <select name="num_customers_to_show" id="num_customers_to_show" class="form-control form-control-sm" onchange="this.form.submit()">
                {% for i in num_customers_options %}
                    <option value="{{ i }}" {% if i == submitted_num_customers %}selected{% endif %}>{{ i }}명</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group mr-2">
            <label for="num_vehicles_to_show" class="mr-2">차량 수 (1-5):</label>
            <select name="num_vehicles_to_show" id="num_vehicles_to_show" class="form-control form-control-sm" onchange="this.form.submit()">
                {% for i in num_vehicles_options %}
                    <option value="{{ i }}" {% if i == submitted_num_vehicles %}selected{% endif %}>{{ i }}대</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group mr-2">
            <label for="num_vehicle_capa_to_show" class="mr-2">차량 용량 (50-200), (모든 차량 동일)</label>
            <select name="num_vehicle_capa_to_show" id="num_vehicle_capa_to_show" class="form-control form-control-sm" onchange="this.form.submit()">
                {% for i in vehicle_capa_options %}
                    <option value="{{ i }}" {% if i == submitted_vehicle_capa %}selected{% endif %}>{{ i }}</option>
                {% endfor %}
            </select>
        </div>
        <noscript><button type="submit" class="btn btn-sm btn-secondary">설정 적용</button></noscript>
    </form>

    <form method="POST" id="cvrpForm">
        {% csrf_token %}
        <input type="hidden" name="problem_type" value="CVRP" id="problem_type">
        <input type="hidden" name="num_customers" value="{{ submitted_num_customers }}" id="form_num_customers">
        <input type="hidden" name="num_vehicles" value="{{ submitted_num_vehicles }}" id="form_num_vehicles">
        <input type="hidden" name="vehicle_capacity" value="{{ submitted_vehicle_capa }}" id="form_vehicle_capa">
        <div class="form-section">
            <h4>1. 위치 지정 (차고지 1개, 고객 {{ submitted_num_customers }}명, 차량 {{submitted_num_vehicles}}대)</h4>
            <p>최초 좌측 상단 파란색으로 초기화 됩니다. 차고지 위치를 변경하려면 아래 위치 초기화 버튼을 클릭하세요.</p>
            <p id="canvasInstructions">먼저 차고지(Depot) 위치를 클릭하세요.</p>
            <canvas id="vrpCanvasInput" width="600" height="400"></canvas>
            <button type="button" class="btn btn-sm btn-warning mb-2" id="resetLocationsBtn">위치 초기화</button>

            <h5>지정된 위치:</h5>
            <div id="locationsDisplay" class="location-list">
                <p>아직 지정된 위치가 없습니다.</p>
            </div>

            <input type="hidden" name="depot_x" id="hidden_depot_x" value="{{ form_data.depot_x|default_if_none:'0' }}">
            <input type="hidden" name="depot_y" id="hidden_depot_y" value="{{ form_data.depot_y|default_if_none:'0' }}">

            {% for i in submitted_num_customers|get_range %}
                {% make_key 'cust' i 'id' as key_name %}
                <input type="hidden" name="cust_{{ i }}_id" id="hidden_cust_{{ i }}_id"
                       value="{{ form_data|get_item_simple:key_name }}">
                {% make_key 'cust' i 'x' as key_name %}
                <input type="hidden" name="cust_{{ i }}_x" id="hidden_cust_{{ i }}_x"
                       value="{{ form_data|get_item_simple:key_name }}">
                {% make_key 'cust' i 'y' as key_name %}
                <input type="hidden" name="cust_{{ i }}_y" id="hidden_cust_{{ i }}_y"
                       value="{{ form_data|get_item_simple:key_name }}">
                {% make_key 'cust' i 'demand' as key_name %}
                <input type="hidden" name="cust_{{ i }}_demand" id="hidden_cust_{{ i }}_demnad"
                       value="{{ form_data|get_item_simple:key_name }}">
            {% endfor %}
        </div>

        <div class="form-section">
             <h4>3. 고객별 수요량 입력 (총 {{ submitted_num_customers }}명)</h4>
            {% for i in submitted_num_customers|get_range %}
                <div class="form-row align-items-center mb-2">
                    {% make_key 'cust' i 'id' as key_name %}
                    <div class="col-md-4">
                        <label for="display_cust_{{ i }}_id">고객 ID </label>
                        <input type="text" class="form-control form-control-sm" id="display_cust_{{ i }}_id"
                               value="{{ form_data|get_item_simple:key_name }}" readonly>
                    </div>
                    {% make_key 'cust' i 'demand' as key_name %}
                    <div class="col-md-4">
                        <label for="cust_{{ i }}_demand">수요량:</label>
                        <input type="number" min="0" class="form-control form-control-sm" id="cust_{{ i }}_demand" name="cust_{{ i }}_demand"
                               value="{{ form_data|get_item_simple:key_name }}" required>
                    </div>
                </div>
            {% endfor %}
        </div>

        <button type="submit" class="btn btn-primary btn-lg mt-3 mb-3">CVRP 최적 경로 계산 실행</button>
    </form>

    {# 1. 결과 메세지 #}
    {% if success_save_message%}
        <div class="alert alert-success" role="alert">{{ success_save_message }}</div>
    {% endif %}
    {% if opt_results is not None or error_message or success_message %}
    <hr class="my-4">
    <h3 class="mt-4">Optimization Results ({{ form_data.problem_type }})</h3>
    {% endif %}
    {% if error_message %}
        <div class="alert alert-danger" role="alert"><strong>오류:</strong> {{ error_message }}</div>
    {% endif %}
    {% if success_message and not error_message %}
        <div class="alert alert-success" role="alert">{{ success_message }}</div>
    {% endif %}

    {# 2. 결과 요약 및 시각화 #}
    {% if opt_results %}
    <div class="card mt-4">
        <div class="card-header"><strong>결과 요약</strong></div>
        <div class="card-body">
            <p><strong>총 운행 거리:</strong> {{ opt_results.total_distance|floatformat:2 }}</p>
            <p><strong>사용된 차량 수:</strong> {{ opt_results.routes|length }} / {{ submitted_num_vehicles }}</p>
            <p><strong>총 처리된 수요량:</strong> {{ opt_results.total_demand_served }}</p>
            {% if opt_results.dropped_nodes %}
                <p class="text-danger"><strong>방문 실패 고객 수:</strong> {{ opt_results.dropped_nodes|length }}</p>
            {% endif %}
            <p><small>처리 시간: {{ processing_time_seconds }} 초</small></p>
        </div>
    </div>

    {% if opt_results.routes %}
    <div class="card mt-3">
        <div class="card-header"><strong>차량별 최적 경로 및 적재량</strong></div>
        <div class="table-responsive">
            <table class="table table-sm table-hover results-table mb-0">
                <thead class="thead-light">
                    <tr>
                        <th>차량 ID</th>
                        <th>경로 (고객 ID 순서)</th>
                        <th>이동 거리</th>
                        <th>총 적재량 / 차량용량</th>
                    </tr>
                </thead>
                <tbody>
                    {% for route in opt_results.routes %}
                    <tr>
                        <td>차량 {{ route.vehicle_id|add:1 }}</td>
                        <td class="route-path">
                            {% for loc_coord_tuple in route.route_locations %}
                                {% with x_coord=loc_coord_tuple.0 y_coord=loc_coord_tuple.1 %}
                                    {% if forloop.first or forloop.last %}
                                        Depot
                                    {% else %}
                                        {# 고객 ID를 찾기 위한 로직 - form_data 또는 plot_data.locations 사용 가능 #}
                                        {% for cust_loc in plot_data.locations %}
                                            {% if cust_loc.x == x_coord and cust_loc.y == y_coord and cust_loc.id != 'Depot' %}
                                                {{ cust_loc.id }}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                    ({{ x_coord|floatformat }},{{ y_coord|floatformat }}){% if not forloop.last %} &rarr; {% endif %}
                                {% endwith %}
                            {% endfor %}
                        </td>
                        <td>{{ route.distance|floatformat:2 }}</td>
                        <td>{{ route.load }} / {{ route.capacity }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {% if plot_data %}
    <div class="card mt-3">
        <div class="card-header"><strong>경로 시각화 (CVRP)</strong></div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="cvrpRouteChart"></canvas> {# 차트 ID 변경 #}
            </div>
        </div>
    </div>
    {% endif %}

    {% elif request.method == 'POST' and not error_message and not success_message and not success_save_message %}
        <p class="text-muted mt-3"><em>최적화 결과가 없습니다. 입력값을 확인하거나, 솔버가 해를 찾지 못했을 수 있습니다.</em></p>
    {% endif %}

</div>
{% endblock %}

{% block scripts %}
<script>
    // 차트 인스턴스 관리
    var chartInstances = window.chartInstances || {};
    function destroyChartIfExists(chartId) {
        if (chartInstances[chartId]) {
            chartInstances[chartId].destroy();
            delete chartInstances[chartId];
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        console.log("CVRP Demo page with graphical input loaded.");

        const canvas = document.getElementById('vrpCanvasInput'); // 이 ID는 VRP와 공유 가능
        const ctx = canvas.getContext('2d');
        const instructions = document.getElementById('canvasInstructions');
        const locationsDisplay = document.getElementById('locationsDisplay');
        const resetBtn = document.getElementById('resetLocationsBtn');

        const depotHiddenX = document.getElementById('hidden_depot_x');
        const depotHiddenY = document.getElementById('hidden_depot_y');

        const numCustomers = parseInt(document.getElementById('form_num_customers').value);
        let customerHiddenX = [];
        let customerHiddenY = [];
        let customerHiddenId = [];
        let customerHiddenDemand = []; // 수요량 숨겨진 필드용 배열

        for (let i = 0; i < numCustomers; i++) {
            customerHiddenX.push(document.getElementById(`hidden_cust_${i}_x`));
            customerHiddenY.push(document.getElementById(`hidden_cust_${i}_y`));
            customerHiddenId.push(document.getElementById(`hidden_cust_${i}_id`));
            customerHiddenDemand.push(document.getElementById(`hidden_cust_${i}_demand`)); // 수요량 필드
        }

        let depot = null;
        let customers = []; // {id, x, y, demand}
        let currentCustomerIndex = 0;
        let placingDepot = true;

        function loadInitialValues() {
            if (depotHiddenX.value && depotHiddenY.value) {
                depot = { x: parseFloat(depotHiddenX.value), y: parseFloat(depotHiddenY.value) };
            } else { // GET 요청 시 기본값으로 depot 설정 (예: 캔버스 중앙)
                depot = {x: canvas.width / 2, y: canvas.height / 2};
                depotHiddenX.value = depot.x.toFixed(2);
                depotHiddenY.value = depot.y.toFixed(2);
            }

            customers = new Array(numCustomers).fill(null); // 먼저 null로 채움
            for (let i = 0; i < numCustomers; i++) {
                const idVal = customerHiddenId[i] ? customerHiddenId[i].value : `C${i+1}`;
                const xVal = customerHiddenX[i] ? customerHiddenX[i].value : null;
                const yVal = customerHiddenY[i] ? customerHiddenY[i].value : null;
                const demandVal = customerHiddenDemand[i] ? customerHiddenDemand[i].value : null; // 수요량 값

                if (xVal && yVal) { // 좌표값이 있을 때만 객체 생성
                    customers[i] = {
                        id: idVal,
                        x: parseFloat(xVal),
                        y: parseFloat(yVal),
                        demand: demandVal ? parseInt(demandVal) : 0 // 수요량 (없으면 0)
                    };
                }
                // 수요량 입력 필드(보이는 필드)에도 값 설정
                const demandInputField = document.getElementById(`cust_${i}_demand`);
                if (demandInputField && demandVal) {
                    demandInputField.value = demandVal;
                }
            }

            if (depot) placingDepot = false;
            currentCustomerIndex = customers.findIndex(c => c === null);
            if (currentCustomerIndex === -1 && depot) {
                 currentCustomerIndex = numCustomers;
            } else if (currentCustomerIndex === -1 && !depot) {
                placingDepot = true;
                currentCustomerIndex = 0;
            } else if (depot && currentCustomerIndex === -1 && numCustomers === 0) { // 고객이 0명인 경우
                currentCustomerIndex = 0; // 또는 numCustomers
            }


            updateInstructionsAndDisplay();
            redrawCanvas();
        }

        function redrawCanvas() {
            // ... (VRP와 동일, 고객 그릴 때 수요량도 표시 가능 - 예: 점 크기 조절) ...
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (depot) {
                ctx.fillStyle = 'blue'; ctx.beginPath(); ctx.arc(depot.x, depot.y, 7, 0, 2 * Math.PI); ctx.fill();
                ctx.fillStyle = 'white'; ctx.fillText('D', depot.x - 4, depot.y + 4);
            }
            customers.forEach((cust, index) => {
                if (cust) {
                    ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(cust.x, cust.y, 5, 0, 2 * Math.PI); ctx.fill();
                    ctx.fillStyle = 'black';
                    let label = cust.id || `C${index+1}`;
                    if (cust.demand) label += `(${cust.demand})`; // 수요량 표시
                    ctx.fillText(label, cust.x + 8, cust.y + 4);
                }
            });
        }

        function updateInstructionsAndDisplay() {
            // ... (VRP와 유사, locationsDisplay에 수요량도 표시 가능) ...
            let html = '';
            if (depot) {
                html += `<p><strong>Depot:</strong> (${depot.x.toFixed(1)}, ${depot.y.toFixed(1)})</p>`;
            } else {
                 html += `<p>Depot: Not set</p>`;
            }

            html += "<h6>Customers:</h6>";
            for (let i = 0; i < numCustomers; i++) {
                if (customers[i]) {
                    html += `<p><strong>${customers[i].id}:</strong> (${customers[i].x.toFixed(1)}, ${customers[i].y.toFixed(1)}) Demand: ${document.getElementById('cust_'+i+'_demand') ? document.getElementById('cust_'+i+'_demand').value : 'N/A'}</p>`;
                } else {
                    html += `<p>Customer ${i+1}: Not set</p>`;
                }
            }
            locationsDisplay.innerHTML = html;

            if (placingDepot) {
                instructions.textContent = '차고지(Depot) 위치를 클릭하세요.';
            } else if (currentCustomerIndex < numCustomers) {
                instructions.textContent = `고객 ${currentCustomerIndex + 1} (${document.getElementById('hidden_cust_'+currentCustomerIndex+'_id').value}) 위치를 클릭하세요. (${numCustomers - currentCustomerIndex}명 남음)`;
            } else {
                instructions.textContent = '모든 위치가 지정되었습니다. 수요량을 확인하고 "최적 경로 계산 실행" 버튼을 누르세요.';
            }
        }

        canvas.addEventListener('click', function(event) {
            // ... (VRP와 유사, customers 객체에 demand는 일단 0 또는 기본값으로 설정) ...
            // 수요량은 별도 input에서 입력받고, POST 시 함께 전송됨. Canvas 클릭은 좌표만.
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            if (placingDepot) {
                depot = { x: x, y: y };
                depotHiddenX.value = x.toFixed(2); // 소수점 2자리로 저장
                depotHiddenY.value = y.toFixed(2);
                placingDepot = false;
                currentCustomerIndex = customers.findIndex(c => c === null); // 다음 고객 찾기
                 if (currentCustomerIndex === -1 && numCustomers > 0) currentCustomerIndex = 0;
                 else if (numCustomers === 0) currentCustomerIndex = 0; // 고객 0명 처리
            } else if (currentCustomerIndex < numCustomers) {
                const custIdInput = document.getElementById(`hidden_cust_${currentCustomerIndex}_id`);
                const custId = custIdInput ? custIdInput.value : `C${currentCustomerIndex+1}`;

                customers[currentCustomerIndex] = {
                    id: custId,
                    x: x, y: y,
                    demand: parseInt(document.getElementById(`cust_${currentCustomerIndex}_demand`).value) || 0 // 현재 입력된 수요량 반영
                };

                if (customerHiddenX[currentCustomerIndex]) customerHiddenX[currentCustomerIndex].value = x.toFixed(2);
                if (customerHiddenY[currentCustomerIndex]) customerHiddenY[currentCustomerIndex].value = y.toFixed(2);
                // 수요량 숨겨진 필드는 별도 input에서 관리되므로 여기서 업데이트 안 함.

                currentCustomerIndex = customers.findIndex(c => c === null);
                if (currentCustomerIndex === -1) { // 모든 고객이 지정됨
                    currentCustomerIndex = numCustomers; // 더 이상 고객을 받지 않음
                }
            }
            updateInstructionsAndDisplay();
            redrawCanvas();
        });

        resetBtn.addEventListener('click', function() {
            // ... (VRP와 유사, customers 배열 초기화 시 demand도 고려) ...
            depot = null;
            customers = new Array(numCustomers).fill(null); // 고객 배열 초기화
            depotHiddenX.value = '';
            depotHiddenY.value = '';
            for (let i = 0; i < numCustomers; i++) {
                if(customerHiddenX[i]) customerHiddenX[i].value = '';
                if(customerHiddenY[i]) customerHiddenY[i].value = '';
                // ID와 수요량 입력 필드(보이는 것)도 초기화
                const idDisplayField = document.getElementById(`display_cust_${i}_id`);
                if (idDisplayField) idDisplayField.value = `C${i+1}`; // ID 표시 필드
                const idHiddenField = document.getElementById(`hidden_cust_${i}_id`);
                if (idHiddenField) idHiddenField.value = `C${i+1}`; // 숨겨진 ID 필드

                const demandField = document.getElementById(`cust_${i}_demand`);
                if (demandField) demandField.value = '30'; // 수요량 기본값
                if(customerHiddenDemand[i]) customerHiddenDemand[i].value = '30'; // 숨겨진 수요량 필드
            }
            placingDepot = true;
            currentCustomerIndex = 0;
            updateInstructionsAndDisplay();
            redrawCanvas();
            console.log("Locations reset.");
        });

        // 페이지 로드 시 초기값으로 캔버스 및 상태 업데이트
        loadInitialValues();

        // --- 결과 CVRP 차트 그리기 로직 ---
        const plotDataJson = '{{ plot_data|safe|default_if_none:"{}" }}';
        try {
            const plotData = JSON.parse(plotDataJson);
            if (plotData && plotData.locations && plotData.routes) {
                const cvrpCtxElement = document.getElementById('cvrpRouteChart'); // 차트 ID 변경
                if (cvrpCtxElement) {
                    destroyChartIfExists('cvrpRouteChart');

                    const datasets = [];
                    // 고객 위치 (수요량에 따라 점 크기 다르게 표현 가능 - 고급)
                    const customerPoints = plotData.locations.slice(1).map(loc => ({x: loc.x, y: loc.y, demand: loc.demand}));
                    datasets.push({
                        type: 'scatter', label: '고객 위치 (수요량)',
                        data: customerPoints.map(p => ({x:p.x, y:p.y})), // 차트에는 x,y만
                        backgroundColor: 'rgba(255, 99, 132, 0.8)',
                        pointRadius: function(context) { // 수요량에 따라 점 크기 조절
                            var index = context.dataIndex;
                            var demand = customerPoints[index] ? customerPoints[index].demand : 5;
                            return 3 + Math.sqrt(demand) * 1.5; // 예시: 수요량 제곱근에 비례
                        }
                    });

                    if (plotData.locations.length > 0) {
                        datasets.push({
                            type: 'scatter', label: '차고지 (Depot)',
                            data: [{x: plotData.locations[0].x, y: plotData.locations[0].y}],
                            backgroundColor: 'rgba(54, 162, 235, 0.8)', pointRadius: 8, pointStyle: 'rectRot'
                        });
                    }

                    const routeColors = ['rgba(75, 192, 192, 0.8)', 'rgba(255, 159, 64, 0.8)', 'rgba(153, 102, 255, 0.8)', 'rgba(255, 205, 86, 0.8)', 'rgba(50, 205, 50, 0.8)'];
                    plotData.routes.forEach((route, index) => {
                        datasets.push({
                            type: 'line', label: `차량 ${route.vehicle_id + 1} 경로`,
                            data: route.path_coords.map(coord => ({x: coord[0], y: coord[1]})),
                            borderColor: routeColors[index % routeColors.length], borderWidth: 2.5, fill: false, tension: 0
                        });
                    });

                    chartInstances['cvrpRouteChart'] = new Chart(cvrpCtxElement, {
                        data: { datasets: datasets },
                        options: { /* ... VRP와 유사한 옵션 ... */
                            plugins: {
                                title: { display: true, text: 'CVRP 경로 시각화' },
                                legend: { position: 'top' },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) { label += ': '; }
                                            if (context.dataset.type === 'scatter' && context.dataIndex < customerPoints.length) {
                                                const customer = plotData.locations[context.dataIndex + 1]; // +1 for depot offset
                                                if (customer) {
                                                    label += `(${context.parsed.x.toFixed(1)}, ${context.parsed.y.toFixed(1)}) ID: ${customer.id}, Demand: ${customer.demand}`;
                                                }
                                            } else if (context.dataset.type === 'line') {
                                                // 라인 툴팁은 기본값 사용 또는 경로 정보 추가
                                            }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }
        } catch (e) {
            console.error("Error parsing CVRP plot data or initializing chart:", e);
        }
    });
</script>
{% endblock %}