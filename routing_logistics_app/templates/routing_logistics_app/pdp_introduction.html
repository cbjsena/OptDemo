{% extends "core/base.html" %}
{% load static %}

{% block title %}Pickup and Delivery Problem (PDP) - Introduction{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'core/css/instruction.css' %}">
    <link rel="stylesheet" href="{% static 'core/css/model.definition.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid introduction-content">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h2 class="h2">수거 및 배송 문제 (Pickup and Delivery Problem - PDP)</h2>
    </div>

    <p class="lead">
        <strong>수거 및 배송 문제(PDP)</strong>는 단순히 여러 고객을 방문하는 VRP를 넘어, 특정 지점에서 물품을 수거(Pickup)하여
        다른 특정 지점으로 배송(Delivery)하는 '한 쌍의 작업'들을 처리하는 최적 경로를 찾는 문제입니다.
    </p>

    <figure class="text-center my-4">
        <img src="{% static 'routing_logistics_app/images/pdp_concept.png' %}" alt="PDP 개념도" class="intro-image img-fluid" style="max-width: 700px;">
        <figcaption class="image-caption mt-2">그림 1: PDP 개념 - 모든 경로는 각 작업의 수거 지점(P)을 배송 지점(D)보다 반드시 먼저 방문해야 하는 '선행 제약'을 따릅니다.</figcaption>
    </figure>

    <div class="row">
        <div class="col-lg-8">
            <h3>1. 문제 설명 및 핵심 제약</h3>
            <p>
                PDP의 목표는 총 운행 비용을 최소화하는 것이지만, 다음과 같은 고유하고 중요한 제약 조건들이 추가되어 문제의 복잡성이 크게 증가합니다.
            </p>
            <div class="highlight-box">
                <h4>PDP의 핵심 제약 조건</h4>
                <ul>
                    <li><strong>선행 제약 (Precedence):</strong> 모든 작업에 대해, 수거 지점 방문이 반드시 해당 배송 지점 방문보다 먼저 이루어져야 합니다.</li>
                    <li><strong>쌍 제약 (Pairing):</strong> 특정 물품의 수거와 배송은 반드시 동일한 차량에 의해 수행되어야 합니다.</li>
                    <li><strong>동적 용량 제약 (Capacity):</strong> 차량의 적재량은 수거 시 증가하고 배송 시 감소하며, 항상 최대 용량을 초과할 수 없습니다.</li>
                </ul>
            </div>

            <h3>2. 산업 응용 분야</h3>
            <ul>
                <li><strong>공유 모빌리티 재배치:</strong> 사용량이 많은 지역(수거)에서 적은 지역(배송)으로 공유 자전거, 스쿠터 등을 효율적으로 재배치합니다.</li>
                <li><strong>환자 및 승객 운송 (Dial-a-Ride):</strong> 여러 승객의 출발지(수거)와 목적지(배송) 요청을 받아 운행하는 셔틀 버스, 콜택시 등의 최적 경로를 생성합니다.</li>
                <li><strong>기업 간 물류 (B2B Logistics):</strong> 부품 공급업체(수거)에서 생산 공장(배송)으로 자재를 운송하거나, 여러 지점의 반품을 수거하여 물류센터로 이송합니다.</li>
            </ul>

            <h3>3. 수학적 모델</h3>
            <p>PDP 모델은 VRP/CVRP 모델에 선행 및 쌍 제약을 모델링하기 위한 추가적인 제약식이 필요합니다.</p>
            <h4>목적 함수 및 기본 제약 조건</h4>
            <p>총 이동 거리를 최소화하는 목적 함수와 고객 방문, 차량 흐름 보존 등 VRP의 기본 제약 조건들은 그대로 유지됩니다.</p>
            <div class="model-definition-content highlight-box">
                <h4 class="model-definition-content"><strong>추가 입력 데이터:</strong></h4>
                <ul>
                    <li><strong>\( K \)</strong> : 사용 가능한 차량의 집합 (인덱스: \( k \))</li>
                    <li><strong>\( R \)</strong> : 수거-배송 요청(Request)의 집합, 각 요청 \(r \in R\)은 한 쌍의 노드 \((p_r, d_r)\)로 구성, (인덱스: \(r\))</li>
                    <li><strong>\( P \)</strong> : 수거 노드의 집합, \( p_r \in P \)</li>
                    <li><strong>\( D \)</strong> : 배송 노드의 집합. \( d_r \in D \)</li>
                    <li><strong>\( N \)</strong> : 모든 작업 지점, \( N = P \cup  D \)</li>
                    <li><strong>\( q_r \)</strong> : 작업 \( r \) 과 관련된 물품의 양, 수거 시 양수, 배송 시 음수</li>
                    <li><strong>\( Q_k \)</strong> : 차량 \( k \)의 최대 적재 용량</li>
                    <li><strong>\( BigM \)</strong> : 매우 큰 양의 상수</li>
                    <li><strong>\( s_i \)</strong> : 노드 \( i \) 에서의 상하차 등 서비스에 소요되는 시간</li>
                </ul>
                <hr>

                <h4 class="model-definition-content"><strong>추가 결정 변수:</strong></h4>
                <ul>
                    <li> <strong>\( u_{ik} \)</strong> : 차량 \( k \) 가 노드 \( i \) 에 도착하는 시간(선후 관계 정의용)</li>
                    <li> <strong>\( l_{ik} \)</strong> : 차량 \( k \) 가 노드 \( i \) 에서 출발할 때의 적재량</li>
                </ul>
                <hr>

                <h4 class="model-definition-content"><strong>PDP 핵심 제약 조건:</strong></h4>
                <ul>
                    <li><strong>시간 흐름 제약:</strong> 만약 차량 \( k \) 가 노드 \( i \) 를 방문한 후 바로 노드 j를 방문한다면(\( x_ijk = 1\)),
                        \( j \)에 도착하는 시간 \( u_{jk} \) 은 \( i \) 에 도착하는 시간 \( u_{ik} \) 에 \( i \) 에서의 서비스 시간과
                        \( i \) 에서 \( j \) 까지의 이동 시간을 더한 값보다 크거나 같아야 합니다.
                        <div class="math-block text-center p-2 my-2 bg-white rounded">
                            $$u_{jk} \ge u_{ik} + s_i + d_{ij} - BigM \cdot (1 - x_{ijk}) \quad \forall i,j \in N_0, i \neq j, \forall k \in K$$
                        </div>
                    </li>
                    <li><strong>선행 제약 (Precedence):</strong> 차량이 작업 \(r\)을 수행할 때, 배송 지점 \(d_r\)의 도착 시간은 수거 지점 \(p_r\)의 도착 시간보다 항상 나중이어야 합니다.
                        <div class="math-block text-center p-2 my-2 bg-white rounded">
                            $$ u_{p_r k} \le u_{d_r k} \quad \forall r \in R, \forall k \in K $$
                        </div>
                    </li>
                    <li><strong>차량 방문 여부 확인 제약:</strong> 이 제약은 경로 변수 \(x_{ijk}\)와 방문 여부 변수 \(y_{ik}\)를 연결합니다.
                        즉, '차량 \( k \) 가 어떤 노드에서든 고객 \( i \) 로 들어오는 경로가 있다면,
                        해당 차량 \( k \) 는 고객 \( i \) 를 방문한 것 \( y_{ik}=1 \) 이다'를 의미합니다.</p>
                        <div class="math-block text-center p-2 my-2 bg-white rounded">
                            $$ \sum_{j \in N_0, j \neq i} x_{jik} = y_{ik} \quad \forall i \in N, \forall k \in K $$
                        </div>
                    </li>
                    <li><strong>쌍 제약 (Pairing):</strong> 수거 지점 \(p_r\)과 배송 지점 \(d_r\)은 반드시 같은 차량 \(k\)에 의해 방문되어야 합니다.
                        <div class="math-block text-center p-2 my-2 bg-white rounded">
                            $$ \sum_{k \in K} y_{p_r,k} = \sum_{k \in K} y_{d_r,k} \quad \forall r \in R$$
                        </div>
                         <p class="small text-muted mb-0"><em>* 차량 k가 수거지점 \(p_r\)에 도착하는 횟수(0 또는 1)와 배송지점 \(d_r\)에 도착하는 횟수가 같아야 함을 의미합니다.</em></p>
                    </li>
                    <li><strong>동적 용량 제약(Dynamic Capacity):</strong> 경로의 각 지점에서의 누적 적재량을 추적하고, 차량의 최대 용량을 초과하지 않도록 제약 합니다.
                        적재량 흐름 제약과 용량 한도 제약을 통해서 동적 용량을 제약합니다.
                        <div>
                            <ul>
                                <li><strong>적재량 흐름 제약:</strong> 차량이 한 노드에서 다음 노드로 이동할 때 적재량이 올바르게 갱신되어야 합니다. 수거 지점에서는 화물량(\(q_r\))만큼 적재량이 늘어나고, 배송 지점에서는 줄어듭니다.
                                    <div class="math-block text-center p-2 my-2 bg-white rounded">
                                     $$ l_{jk} \ge l_{ik} + q_j - M \cdot (1-x_{ijk}) \quad \forall i,j \in N_0, \forall k \in K $$
                                    </div>
                                     <p class="small text-muted mb-1"><em>* \(q_j\)는 노드 j에서의 수요량 (수거 시 + , 배송 시 -), M은 매우 큰 상수입니다. 이 제약은 \(x_{ijk}=1\)일 때만 \(l_{jk} \approx l_{ik} + q_j\)가 성립하도록 합니다.</em></p>
                                </li>
                                <li><strong>용량 한도 제약:</strong> 경로의 모든 지점에서, 차량의 적재량은 0 이상이어야 하며, 차량의 최대 용량(\(Q_k\))을 초과할 수 없습니다.
                                    <div class="math-block text-center p-2 my-2 bg-white rounded">
                                        $$ 0 \le l_{ik} \le Q_k \quad \forall i \in N_0, \forall k \in K $$
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-success text-white">
                    <h4 class="h5 mb-0">PDP Demo 체험하기</h4>
                </div>
                <div class="card-body">
                    <p><strong>PDP Demo</strong>에서는 아래와 같은 기능을 직접 체험해볼 수 있습니다.</p>
                    <ul>
                        <li>차량 수 및 용량 설정</li>
                        <li>여러 개의 수거-배송 쌍 위치 설정</li>
                        <li>복잡한 제약을 만족하는 최적 경로 확인</li>
                    </ul>
                    <a href="{% url 'routing_logistics_app:pdp_demo' %}" class="btn btn-success btn-block mt-3">
                        데모 페이지로 이동 &rarr;
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
{% endblock %}