{% extends "core/base.html" %}
{% load static %}

{% block title %}Pickup and Delivery Problem (PDP) - Introduction{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'core/css/instruction.css' %}">
    <link rel="stylesheet" href="{% static 'core/css/model.definition.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid introduction-content">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h2 class="h2">수거 및 배송 문제 (Pickup and Delivery Problem - PDP)</h2>
    </div>

    <p class="lead">
        <strong>수거 및 배송 문제(PDP)</strong>는 단순히 여러 고객을 방문하는 VRP를 넘어, 특정 지점에서 물품을 수거(Pickup)하여
        다른 특정 지점으로 배송(Delivery)하는 '한 쌍의 작업'들을 처리하는 최적 경로를 찾는 문제입니다.
    </p>

    <figure class="text-center my-4">
        <img src="{% static 'routing_logistics_app/images/pdp_concept.png' %}" alt="PDP 개념도" class="intro-image img-fluid" style="max-width: 700px;">
        <figcaption class="image-caption mt-2">그림 1: PDP 개념 - 모든 경로는 각 작업의 수거 지점(P)을 배송 지점(D)보다 반드시 먼저 방문해야 하는 '선행 제약'을 따릅니다.</figcaption>
    </figure>

    <div class="row">
        <div class="col-lg-8">
            <h3>1. 문제 설명 및 핵심 제약</h3>
            <p>
                PDP의 목표는 총 운행 비용을 최소화하는 것이지만, 다음과 같은 고유하고 중요한 제약 조건들이 추가되어 문제의 복잡성이 크게 증가합니다.
            </p>
            <div class="highlight-box">
                <h4>PDP의 핵심 제약 조건</h4>
                <ul>
                    <li><strong>선행 제약 (Precedence):</strong> 모든 작업에 대해, 수거 지점 방문이 반드시 해당 배송 지점 방문보다 먼저 이루어져야 합니다.</li>
                    <li><strong>쌍 제약 (Pairing):</strong> 특정 물품의 수거와 배송은 반드시 동일한 차량에 의해 수행되어야 합니다.</li>
                    <li><strong>동적 용량 제약 (Capacity):</strong> 차량의 적재량은 수거 시 증가하고 배송 시 감소하며, 항상 최대 용량을 초과할 수 없습니다.</li>
                </ul>
            </div>

            <h3>2. 산업 응용 분야</h3>
            <ul>
                <li><strong>공유 모빌리티 재배치:</strong> 사용량이 많은 지역(수거)에서 적은 지역(배송)으로 공유 자전거, 스쿠터 등을 효율적으로 재배치합니다.</li>
                <li><strong>환자 및 승객 운송 (Dial-a-Ride):</strong> 여러 승객의 출발지(수거)와 목적지(배송) 요청을 받아 운행하는 셔틀 버스, 콜택시 등의 최적 경로를 생성합니다.</li>
                <li><strong>기업 간 물류 (B2B Logistics):</strong> 부품 공급업체(수거)에서 생산 공장(배송)으로 자재를 운송하거나, 여러 지점의 반품을 수거하여 물류센터로 이송합니다.</li>
            </ul>

            <h3>3. 수학적 모델</h3>
            <p>PDP 모델은 VRP/CVRP 모델에 선행 및 쌍 제약을 모델링하기 위한 추가적인 제약식이 필요합니다.<br>
                VRP의 기본 목적 함수와 제약 조건들(고객 방문, 차량 흐름 보존 등)은 그대로 유지됩니다.</p>
            <div class="model-definition-content highlight-box">
                <h4 class="model-definition-content"><strong>추가 입력 데이터:</strong></h4>
                <ul>
                    <li><strong>\( K \)</strong> : 사용 가능한 차량의 집합 (인덱스: \( k \))</li>
                    <li><strong>\( R \)</strong> : 수거-배송 요청(Request)의 집합, 각 요청 \(r \in R\)은 한 쌍의 노드 \((p_r, d_r)\)로 구성, (인덱스: \(r\))</li>
                    <li><strong>\( P \)</strong> : 수거 노드의 집합, \( p_r \in P \)</li>
                    <li><strong>\( D \)</strong> : 배송 노드의 집합. \( d_r \in D \)</li>
                    <li><strong>\( N_0 \)</strong> : 차고지(0)를 포함한 모든 노드 집합 (\(N_0 = P \cup D \cup \{0\}\))</li>
                    <li><strong>\( d_{ij} \)</strong> : 노드 \(i\)에서 \(j\)로의 이동 비용/거리</li>
                    <li><strong>\( t_{ij} \)</strong> : 노드 \(i\)에서 \(j\)로의 이동 시간</li>
                    <li><strong>\( q_r \)</strong> : 작업 \( r \) 과 관련된 물품의 양, 수거 시 양수, 배송 시 음수</li>
                    <li><strong>\( Q_k \)</strong> : 차량 \( k \)의 최대 적재 용량</li>
                    <li><strong>\( s_i \)</strong> : 노드 \( i \) 에서의 서비스 시간 (상하차 등)</li>
                    <li><strong>\( BigM \)</strong> : 매우 큰 양의 상수</li>
                </ul>
                <hr>

                <h4 class="model-definition-content"><strong>추가 결정 변수:</strong></h4>
                <ul>
                    <li><strong>\( x_{ijk} \)</strong> : 차량 \(k\) 가 노드 \(i\) 에서 \(j\) 로 직접 이동하면 1, 아니면 0</li>
                    <li><strong>\( u_{ik} \)</strong> : 차량 \( k \) 가 노드 \( i \) 에 도착하는 시간(선후 관계 정의용)</li>
                    <li><strong>\( l_{ik} \)</strong> : 차량 \( k \) 가 노드 \( i \) 에서 출발할 때의 적재량</li>
                </ul>
                <hr>

                <h4 class="model-definition-content"><strong>PDP 핵심 제약 조건:</strong></h4>
                <ul>
                    <li><strong>1. 쌍 제약 (Pairing):</strong> 각 요청의 수거와 배송은 반드시 동일한 차량으로 처리되어야 합니다.
                        특정 차량 \( k \) 가 요청 \( r \)의 수거 지점과 배송 지점을 모두 방문하거나, 모두 방문하지 않도록 강제합니다.
                        <div class="math-block text-center p-2 my-2 bg-white rounded">
                            $$ \sum_{i \in N_0} x_{i,p_r,k} = \sum_{j \in N_0} x_{j,d_r,k} \quad \forall r \in R, \forall k \in K $$
                        </div>
                    </li>
                    <li><p><strong>2. 시간 흐름 및 선행 제약 (Time Flow & Precedence):</strong></p>
                        <div>
                            <ul>
                                <li><strong>시간 흐름 제약:</strong>경로가 시간을 거스르는 것을 방지합니다.
                                    차량 \( k \) 가 노드 \( i \)  &rarr; 노드 \( j \) 이면 (\( x_{ijk} = 1\)), \( j \) 도착 시간 > \( i \) 출발 시간 입니다.
                                    <div class="math-block text-center p-2 my-2 bg-white rounded">
                                        $$u_{jk} \ge u_{ik} + s_i + t_{ij} - BigM \cdot (1 - x_{ijk}) \quad \forall i,j \in N_0, i \neq j, \forall k \in K$$
                                    </div>
                                </li>
                                <li><strong>선행 제약 (Precedence):</strong> 배송지 도착 시간은 수거지에서 출발한 시간(도착 시간 + 서비스 시간)보다 나중이어야 한다
                                    <div class="math-block text-center p-2 my-2 bg-white rounded">
                                        $$ u_{d_r, k} \ge u_{p_r, k} + s_{p_r} + t_{p_r, d_r} \quad \forall r \in R, \forall k \in K $$
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </li>
                    <li><p><strong>3. 동적 용량 제약(Dynamic Capacity):</strong> 경로의 각 지점에서의 누적 적재량을 추적하고, 차량의 최대 용량을 초과하지 않도록 제약 합니다.
                        <div>
                            <ul>
                                <li><strong>적재량 흐름 제약:</strong>차량의 트렁크를 관리하는 규칙입니다.
                                    수거 지점에서는 물건을 실어 화물량(\(q_r\))만큼 적재량이 늘어나고(+),
                                    배송 지점에서는 물건을 내려 화물량(\(q_r\))만큼 적재량이 줄어드는(-) 과정을 표현합니다.
                                    <div class="math-block text-center p-2 my-2 bg-white rounded">
                                     $$ l_{jk} \ge l_{ik} + q_j - M \cdot (1-x_{ijk}) \quad \forall i,j \in N_0, \forall k \in K $$
                                    </div>
                                     <p class="small text-muted mb-1"><em>* 차량 \( k \) 가 노드 \( i \) 를 방문한 후 바로 노드 \( j \) 를 방문한다면(\( x_{ijk} = 1\)),
                                         노드 \( j \) 에 적재량 \( l_{jk} \) 는 노드 \( i \) 에 적재량 \( l_{ik} \) 에 노드 \( i \) 에서의 화물량 변화량을
                                         반영한 값보다 크거나 같아야 합니다. \(l_{jk} \approx l_{ik} + q_j\)</em></p>
                                </li>
                                <li><strong>용량 한도 제약:</strong> 차량에 실린 짐의 양은 언제나 0 이상이어야 하며, 트럭의 최대 적재 용량을 넘어설 수 없다는 직관적인 규칙입니다.
                                    <div class="math-block text-center p-2 my-2 bg-white rounded">
                                        $$ 0 \le l_{ik} \le Q_k \quad \forall i \in N_0, \forall k \in K $$
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-success text-white">
                    <h4 class="h5 mb-0">PDP Demo 체험하기</h4>
                </div>
                <div class="card-body">
                    <p><strong>PDP Demo</strong>에서는 아래와 같은 기능을 직접 체험해볼 수 있습니다.</p>
                    <ul>
                        <li>차량 수 및 용량 설정</li>
                        <li>여러 개의 수거-배송 쌍 위치 설정</li>
                        <li>복잡한 제약을 만족하는 최적 경로 확인</li>
                    </ul>
                    <a href="{% url 'routing_logistics_app:pdp_demo' %}" class="btn btn-success btn-block mt-3">
                        데모 페이지로 이동 &rarr;
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}