{% extends "core/base.html" %}
{% load static %}
{% load matching_filters %}

{% block title %}Resource-Skill Matching Demo{% endblock %}

{% block styles %}
    <style>
        .form-section { margin-bottom: 2rem; }
        .item-card { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: .3rem; padding: 1rem; margin-bottom: 1rem; }
        .results-card { margin-top: 1rem; }
        .team-members { list-style-type: none; padding-left: 0; }
        .team-members li { background-color: #e9ecef; border-radius: 4px; padding: 5px 10px; margin-bottom: 5px; }
        .skill-tag {
            display: inline-block;
            padding: .25em .6em;
            font-size: 85%;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: .25rem;
            color: #fff;
            background-color: #007bff;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .unassigned-list { color: #6c757d; }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Resource-Skill Matching Demo</h1>
    </div>
    <p>인력들의 보유 기술과 프로젝트의 요구 기술을 바탕으로, 모든 프로젝트 요구사항을 만족시키면서 총 투입 비용을 최소화하는 최적의 팀을 구성합니다.</p>

    <!-- 설정 변경을 위한 숨겨진 GET 폼 -->
    <form method="GET" id="settingsForm" style="display: none;"></form>

    <!-- 상단 컨트롤러 -->
    <div class="card mb-4">
        <div class="card-body bg-light">
            <div class="form-row align-items-end">
                <div class="form-group col-md-4">
                    <label for="num_projects_to_show" class="small font-weight-bold">프로젝트 수</label>
                    <select name="num_projects_to_show" id="num_projects_to_show" class="form-control form-control-sm" onchange="submitSettingsForm()">
                        {% for i in num_projects_options %}
                            <option value="{{ i }}" {% if i == submitted_num_projects %}selected{% endif %}>{{ i }}개</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group col-md-8 text-md-right">
                    <a href="{% url 'matching_assignment_app:resource_skill_matching_demo' %}" class="btn btn-sm btn-warning">Default</a>
                </div>
            </div>
        </div>
    </div>

    <form method="POST" id="skillMatchingForm">
        {% csrf_token %}
        <input type="hidden" name="problem_type" value="resource skill" id="problem_type">
        <input type="hidden" name="num_projects" value="{{ submitted_num_projects }}">

        <div class="card form-section">
            <div class="card-header"><strong>1. 최적화에 포함할 인력 선택</strong></div>
            <div class="card-body table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-sm table-hover input-table">
                    <thead class="thead-light">
                        <tr>
                            <th>포함</th>
                            <th>이름</th>
                            <th>비용 (급여)</th>
                            <th>보유 기술</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for resource in all_resources_data %}
                        <tr>
                            <td>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="selected_resources" value="{{ resource.id }}"
                                           id="res_check_{{ resource.id }}" {% if resource.id in selected_resource_ids %}checked{% endif %}>
                                </div>
                            </td>
                            <td><label for="res_check_{{ resource.id }}">{{ resource.name }}</label></td>
                            <td>{{ resource.cost }}</td>
                            <td>{{ resource.skills }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 프로젝트 정보 테이블 (편집 가능) -->
        <div class="card form-section">
            <div class="card-header"><strong>2. 프로젝트 (Projects) 정보</strong></div>
            <div class="card-body table-responsive">
                <table class="table table-sm table-bordered input-table">
                    <thead class="thead-light">
                        <tr>
                            <th>프로젝트명</th>
                            <th>요구 기술 (쉼표로 구분)</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for project in projects_data %}
                        <tr>
                            <input type="hidden" name="proj_{{ forloop.counter0 }}_id" value="{{ project.id }}">
                            <td><input type="text" class="form-control form-control-sm" name="proj_{{ forloop.counter0 }}_name" value="{{ project.name }}"></td>
                            <td><input type="text" class="form-control form-control-sm" name="proj_{{ forloop.counter0 }}_required_skills" value="{{ project.required_skills }}"></td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <button type="submit" class="btn btn-primary btn-lg mt-3 mb-3">최적 팀 구성 실행</button>
    </form>

    {# 1. 결과 메세지 #}
    {% if success_save_message%}
        <div class="alert alert-success" role="alert">{{ success_save_message }}</div>
    {% endif %}
    {% if opt_results is not None or error_message or success_message %}
    <hr class="my-4">
    <h3 class="mt-4">Optimization Results ({{ active_submenu }})</h3>
    {% endif %}
    {% if error_message %}
        <div class="alert alert-danger" role="alert"><strong>오류:</strong> {{ error_message }}</div>
    {% endif %}
    {% if success_message and not error_message %}
        <div class="alert alert-success" role="alert">{{ success_message }}</div>
    {% endif %}

    {# 2. 결과 요약 및 시각화 #}
    {% if results %}
    <div class="card mt-4">
        <div class="card-header"><strong>결과 요약</strong></div>
        <div class="card-body">
            <p class="h4"><strong>최소 총 투입 비용: {{ results.total_cost|floatformat:0 }}</strong></p>
            <p><small>처리 시간: {{ processing_time_seconds }} 초</small></p>
        </div>
    </div>

    <div class="row mt-3">
        {% for project_name, members in results.assignments.items %}
            <div class="col-md-6">
                <div class="card results-card">
                    <div class="card-header"><strong>{{ project_name }} 팀 구성</strong></div>
                    <div class="card-body">
                        {% if members %}
                            <ul class="team-members">
                            {% for member in members %}
                                <li>
                                    <strong>{{ member.name }}</strong> (비용: {{ member.cost }}) <br>
                                    <small>
                                        {% for skill in member.skills %}
                                        <span class="skill-tag">{{ skill }}</span>
                                        {% endfor %}
                                    </small>
                                </li>
                            {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted">이 프로젝트에 배정된 인력이 없습니다.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <div class="row mt-3">
        {% if results.unassigned_resources %}
        <div class="col-md-6">
            <div class="card results-card">
                <div class="card-header"><strong>미배정 인력 (Selected but Unassigned)</strong></div>
                <div class="card-body">
                    <p class="small text-muted">최적화 대상에 포함되었으나, 비용 또는 기술 문제로 배정되지 않은 인력입니다.</p>
                    <ul class="unassigned-list">
                    {% for resource in results.unassigned_resources %}
                        <li>{{ resource.name }} (비용: {{ resource.cost }})</li>
                    {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}

        {% if unselected_resources %}
        <div class="col-md-6">
            <div class="card results-card">
                <div class="card-header"><strong>미선택 인력 (Not Selected)</strong></div>
                <div class="card-body">
                    <p class="small text-muted">최적화 대상에 포함되지 않은 전체 인력 풀의 나머지 인력입니다.</p>
                    <ul class="unassigned-list">
                    {% for resource in unselected_resources %}
                        <li>{{ resource.name }} (비용: {{ resource.cost }})</li>
                    {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
    function submitSettingsForm() {
        const settingsForm = document.getElementById('settingsForm');
        settingsForm.innerHTML = '';

        // [수정] 프로젝트 수 컨트롤러 값 추가
        const numProjectsSelect = document.getElementById('num_projects_to_show');
        const hiddenNumProjects = document.createElement('input');
        hiddenNumProjects.type = 'hidden';
        hiddenNumProjects.name = 'num_projects_to_show';
        hiddenNumProjects.value = numProjectsSelect.value;
        settingsForm.appendChild(hiddenNumProjects);

        // [신규] 현재 선택된(체크된) 인력들의 ID를 추가
        document.querySelectorAll('input[name="selected_resources"]:checked').forEach(checkbox => {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'selected_resources';
            hiddenInput.value = checkbox.value;
            settingsForm.appendChild(hiddenInput);
        });

        // 현재 프로젝트 정보 추가 (상태 유지)
        const numProjects = {{ submitted_num_projects }};
        for (let i = 0; i < numProjects; i++) {
            ['id', 'name', 'required_skills'].forEach(field => {
                const element = document.querySelector(`input[name="proj_${i}_${field}"]`);
                if (element) {
                    let hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = `proj_${i}_${field}`;
                    hiddenInput.value = element.value;
                    settingsForm.appendChild(hiddenInput);
                }
            });
        }

        settingsForm.submit();
    }
</script>
{% endblock %}
