{% extends "core/base.html" %}
{% load static %}
{% load production_filters %}

{% block title %}Lot Sizing Demo{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Lot Sizing Problem Demo</h1>
    </div>
    <p>각 기간별 수요, 생산/재고/준비 비용, 생산 능력을 입력하여 총비용을 최소화하는 최적의 생산 계획을 수립합니다.</p>

    {# --- 사용자에게 보여지는 컨트롤러 (폼 바깥에 위치) --- #}
    <div class="mb-3 form-inline">
        <div class="form-group mr-2">
            <label for="num_periods_to_show" class="mr-2">계획 기간 수 (3-12):</label>
            <select id="num_periods_to_show" class="form-control form-control-sm" onchange="submitSettingsForm()">
                {% for i in num_periods_options %}
                    <option value="{{ i }}" {% if i == submitted_num_periods %}selected{% endif %}>{{ i }} 기간</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group ml-auto">
            <button type="button" class="btn btn-sm btn-success mr-2" id="randomizeBtn">Random</button>
            <a href="{% url 'production_scheduling_app:lot_sizing_demo' %}" class="btn btn-sm btn-warning">Default</a>
        </div>
    </div>

    {# --- 설정 변경 값을 전달하기 위한 숨겨진 GET 폼 --- #}
    <form method="GET" id="settingsForm" style="display: none;"></form>

    <form method="POST" id="lotSizingForm">
        {% csrf_token %}
        <input type="hidden" name="problem_type" value="lot_sizing" id="problem_type">
        <input type="hidden" name="num_periods" value="{{ submitted_num_periods }}">
        
        <div class="form-section">
            <h4>입력 파라미터</h4>
            <div class="table-responsive">
                <table class="table table-bordered text-center">
                    <thead class="thead-light">
                        <tr>
                            <th>기간 (Period)</th>
                            {% for t in submitted_num_periods|get_range %}
                            <th>{{ t|add:1 }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th>수요량 (Demand)</th>
                            {% for period in periods_data %}
                            <td><input type="number" min="0" id="demand_{{ forloop.counter0 }}" name="demand_{{ forloop.counter0 }}"
                                       class="form-control form-control-sm" value="{{ period.demand }}"></td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <th>생산 준비 비용 (Setup Cost)</th>
                             {% for period in periods_data %}
                            <td><input type="number" min="0" id="setup_cost_{{ forloop.counter0 }}" name="setup_cost_{{ forloop.counter0 }}"
                                       class="form-control form-control-sm" value="{{ period.setup_cost }}"></td>
                            {% endfor %}
                        </tr>
                         <tr>
                            <th>단위당 생산 비용 (Prod. Cost)</th>
                            {% for period in periods_data %}
                            <td><input type="number" min="0" id="prod_cost_{{ forloop.counter0 }}" name="prod_cost_{{ forloop.counter0 }}"
                                       class="form-control form-control-sm" value="{{ period.prod_cost }}"></td>
                            {% endfor %}
                        </tr>
                         <tr>
                            <th>단위당 재고 비용 (Holding Cost)</th>
                             {% for period in periods_data %}
                            <td><input type="number" min="0" id="holding_cost_{{ forloop.counter0 }}" name="holding_cost_{{ forloop.counter0 }}"
                                       class="form-control form-control-sm" value="{{ period.holding_cost }}"></td>
                            {% endfor %}
                        </tr>
                         <tr>
                            <th>최대 생산 능력 (Capacity)</th>
                            {% for period in periods_data %}
                            <td><input type="number" min="0" id="capacity_{{ forloop.counter0 }}" name="capacity_{{ forloop.counter0 }}"
                                       class="form-control form-control-sm" value="{{ period.capacity }}"></td>
                            {% endfor %}
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <button type="submit" class="btn btn-primary btn-lg mt-3 mb-3">최적 생산 계획 실행</button>
    </form>
    {# --- 최적화 입력 데이터 폼 종료 --- #}

    {# 1. 결과 메세지 #}
    {% if success_save_message%}
        <div class="alert alert-success" role="alert">{{ success_save_message }}</div>
    {% endif %}
    {% if opt_results is not None or error_message or success_message %}
    <hr class="my-4">
    <h3 class="mt-4">Optimization Results ({{ active_submenu }})</h3>
    {% endif %}
    {% if error_message %}
        <div class="alert alert-danger" role="alert"><strong>오류:</strong> {{ error_message }}</div>
    {% endif %}
    {% if success_message and not error_message %}
        <div class="alert alert-success" role="alert">{{ success_message }}</div>
    {% endif %}

    {# 2. 결과 요약 및 시각화 #}
    {% if results %}
        {# ... 결과 요약 및 비용 분석 테이블 ... #}
        <div class="card mt-3">
            <div class="card-header"><strong>결과 요약</strong></div>
            <div class="card-body">
                 <p><strong>최소 총 비용:</strong> {{ results.total_cost }}</p>
                 <p><small>처리 시간: {{ processing_time_seconds }} 초</small></p>
            </div>
        </div>
        <div class="card mt-3">
             <div class="card-header"><strong>최적 생산 및 재고 계획</strong></div>
             <div class="table-responsive">
                <table class="table table-sm table-striped text-center mb-0">
                    <thead class="thead-light">
                        <tr>
                            <th>기간</th>
                            <th>수요량</th>
                            <th><strong>생산량 (결정)</strong></th>
                            <th>기말 재고량 (결과)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in results.schedule %}
                        <tr {% if item.is_setup %}class="table-info"{% endif %}>
                            <td>{{ item.period }}</td>
                            <td>{{ item.demand }}</td>
                            <td><strong>{{ item.production_amount }}</strong> {% if item.is_setup %}<span class="badge badge-info">생산준비</span>{% endif %}</td>
                            <td>{{ item.inventory_level }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        {% if plot_data %}
            <div class="card mt-3">
                <div class="card-header"><strong>생산/재고/수요 시각화</strong></div>
                <div class="card-body">
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="lotSizingChart"></canvas>
                    </div>
                </div>
            </div>
        {% endif %}
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    function submitSettingsForm() {
        console.log("Number of periods changed, submitting form with current values.");

        const hiddenSettingsForm  = document.getElementById('settingsForm');
        settingsForm.innerHTML = ''; // 중복 제출 방지를 위해 폼 비우기

        // 드롭다운 메뉴의 현재 값들을 숨겨진 필드로 추가
        const numPeriodsSelect = document.getElementById('num_periods_to_show');
        let inputNumPeriods = document.createElement('input');
        inputNumPeriods.type = 'hidden';
        inputNumPeriods.name = 'num_periods_to_show';
        inputNumPeriods.value = numPeriodsSelect.value;
        settingsForm.appendChild(inputNumPeriods);

        // 2. 현재 테이블의 모든 입력 값을 숨겨진 필드로 추가
        const numPeriodsInTable = {{ submitted_num_periods }};
        const fields = ['demand', 'setup_cost', 'prod_cost', 'holding_cost', 'capacity'];

        for (let i = 0; i < numPeriodsInTable; i++) {
            fields.forEach(field => {
                const inputElement = document.getElementById(`${field}_${i}`);
                if (inputElement) {
                    let hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = `${field}_${i}`;
                    hiddenInput.value = inputElement.value;
                    settingsForm.appendChild(hiddenInput);
                }
            });
        }

        // 3. GET 방식으로 폼 제출
        settingsForm.submit();
    }

    document.addEventListener('DOMContentLoaded', function() {
        const randomizeBtn = document.getElementById('randomizeBtn');
        if (randomizeBtn) {
            randomizeBtn.addEventListener('click', function() {
                console.log("Randomize button clicked.");

                // 범위 내에서 랜덤 정수를 생성하는 헬퍼 함수
                function getRandomInt(min, max) {
                    min = Math.ceil(min);
                    max = Math.floor(max);
                    return Math.floor(Math.random() * (max - min + 1)) + min;
                }

                const numPeriods = parseInt(document.getElementById('num_periods_to_show').value);

                // 각 기간의 입력 필드에 랜덤 값 채우기
                for (let i = 0; i < numPeriods; i++) {
                    const demandInput = document.getElementById(`demand_${i}`);
                    const capacityInput = document.getElementById(`capacity_${i}`);

                    // 수요량과 생산능력은 서로 연관되도록 생성
                    const randomDemand = getRandomInt(50, 150);
                    const randomCapacity = getRandomInt(randomDemand, randomDemand + 100); // 생산능력은 항상 수요량보다 크거나 같게 설정

                    if(demandInput) demandInput.value = randomDemand;
                    if(capacityInput) capacityInput.value = randomCapacity;

                    const setupCostInput = document.getElementById(`setup_cost_${i}`);
                    if(setupCostInput) setupCostInput.value = getRandomInt(200, 500);

                    const prodCostInput = document.getElementById(`prod_cost_${i}`);
                    if(prodCostInput) prodCostInput.value = getRandomInt(5, 15);

                    const holdingCostInput = document.getElementById(`holding_cost_${i}`);
                    if(holdingCostInput) holdingCostInput.value = getRandomInt(1, 5);
                }

                console.log("Form populated with new random data.");
            });
        }

        // 기존 최적화 차트 그리기
        const plotDataJson = '{{ plot_data|safe|default_if_none:"{}" }}';
        try {
            const plotData = JSON.parse(plotDataJson);
            if (plotData && plotData.labels) {
                const ctx = document.getElementById('lotSizingChart');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'bar', // 혼합 차트
                        data: {
                            labels: plotData.labels,
                            datasets: [
                                {
                                    type: 'bar',
                                    label: '생산량',
                                    data: plotData.productions,
                                    backgroundColor: 'rgba(54, 162, 235, 0.6)'
                                },
                                {
                                    type: 'line',
                                    label: '재고량',
                                    data: plotData.inventories,
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    fill: true,
                                    yAxisID: 'y1' // 보조 y축 사용
                                },
                                {
                                    type: 'line',
                                    label: '수요량',
                                    data: plotData.demands,
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    fill: false
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { // 기본 Y축 (생산량, 수요량)
                                    beginAtZero: true,
                                    position: 'left',
                                    title: { display: true, text: '수량 (Units)' }
                                },
                                y1: { // 보조 Y축 (재고량)
                                    beginAtZero: true,
                                    position: 'right',
                                    title: { display: true, text: '재고량 (Units)' },
                                    grid: { drawOnChartArea: false } // 보조축 그리드 숨기기
                                }
                            }
                        }
                    });
                }
            }
        } catch(e) {
        console.error("Error creating lot sizing chart:", e);
    }
});
</script>
{% endblock %}