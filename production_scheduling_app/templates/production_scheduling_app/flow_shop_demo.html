{% extends "core/base.html" %}
{% load static %}
{% load production_filters %}

{% block title %}Flow Shop Scheduling Demo{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Flow Shop Scheduling Demo</h1>
    </div>
    <p>각 작업의 기계별 처리 시간을 입력하여, 전체 작업 완료 시간(Makespan)을 최소화하는 최적의 작업 순서를 계산하고 간트 차트로 확인합니다.</p>

    {# --- 사용자에게 보여지는 컨트롤러 (폼 바깥에 위치) --- #}
    <div class="mb-3 form-inline">
        <div class="form-group mr-2">
            <label for="num_jobs_to_show" class="mr-2">작업 수 (2-8):</label>
            <select id="num_jobs_to_show" class="form-control form-control-sm" onchange="submitSettingsForm()">
                {% for i in num_jobs_options %}
                    <option value="{{ i }}" {% if i == submitted_num_jobs %}selected{% endif %}>{{ i }}개</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group mr-2">
            <label for="num_machines_to_show" class="mr-2">기계 수 (3-5):</label>
            <select id="num_machines_to_show" class="form-control form-control-sm" onchange="submitSettingsForm()">
                {% for i in num_machines_options %}
                    <option value="{{ i }}" {% if i == submitted_num_machines %}selected{% endif %}>{{ i }}대</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group ml-auto">
            <button type="button" class="btn btn-sm btn-success mr-2" id="randomizeBtn">Random</button>
            <a href="{% url 'production_scheduling_app:flow_shop_demo' %}" class="btn btn-sm btn-warning">Default</a>
        </div>
    </div>

    {# --- 설정 변경 값을 전달하기 위한 숨겨진 GET 폼 --- #}
    <form method="GET" id="settingsForm" style="display: none;"></form>

    <form method="POST" id="schedulingForm">
        {% csrf_token %}
        <input type="hidden" name="problem_type" value="flow_shop" id="problem_type">
        <input type="hidden" name="action" value="optimize">
        <input type="hidden" name="num_jobs" value="{{ submitted_num_jobs }}">
        <input type="hidden" name="num_machines" value="{{ submitted_num_machines }}">

        <div class="form-section">
            <h4>작업별/기계별 처리 시간 (Processing Times)</h4>
            <div class="table-responsive">
                <table class="table table-bordered text-center">
                    <thead class="thead-light">
                        <tr>
                            <th>작업 ID</th>
                            {% for j in submitted_num_machines|get_range %}<th>기계 {{ j|add:1 }}</th>{% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for job in jobs_list %}
                        <tr>
                            <td><input type="text" class="form-control form-control-sm"
                                       id="job_{{ forloop.counter0 }}_id" name="job_{{ forloop.counter0 }}_id" value="{{ job.id }}">
                            </td>
                            {% for processing_time in job.processing_times %}
                            <td><input type="number" min="0" class="form-control form-control-sm"
                                       id="p_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}"
                                       name="p_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}" value="{{ processing_time }}">
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary btn-lg mt-3 mb-3">최적 스케줄 계산 실행</button>
    </form>
    {# --- 최적화 입력 데이터 폼 종료 --- #}

    {# 1. 결과 메세지 #}
    {% if success_save_message%}
        <div class="alert alert-success" role="alert">{{ success_save_message }}</div>
    {% endif %}
    {% if opt_results is not None or error_message or success_message %}
    <hr class="my-4">
    <h3 class="mt-4">Optimization Results ({{ form_data.problem_type }})</h3>
    {% endif %}
    {% if error_message %}
        <div class="alert alert-danger" role="alert"><strong>오류:</strong> {{ error_message }}</div>
    {% endif %}
    {% if success_message and not error_message %}
        <div class="alert alert-success" role="alert">{{ success_message }}</div>
    {% endif %}

    {# 2. 결과 요약 및 시각화 #}
    {% if results %}
        <div class="card mt-3">
            <div class="card-header"><strong>결과 요약</strong></div>
            <div class="card-body">
                 <p><strong>최적 작업 순서:</strong> 
                    {% for job_id in results.sequence %}
                        <span class="badge badge-primary" style="font-size: 1rem;">{{ job_id }}</span>{% if not forloop.last %} &rarr; {% endif %}
                    {% endfor %}
                 </p>
                 <p><strong>최소 Makespan:</strong> {{ results.makespan }}</p>
                 <p><small>처리 시간: {{ processing_time_seconds }} 초</small></p>
            </div>
        </div>
        {% if plot_data %}
            <div class="card mt-3">
                <div class="card-header"><strong>[최적화 결과] 간트 차트 (Gantt Chart)</strong></div>
                <div class="card-body">
                    <div class="chart-container" style="height: {{ submitted_num_machines|add:1|multiply_custom:60 }}px;">
                        <canvas id="flowShopGanttChart"></canvas>
                    </div>
                </div>
            </div>
        {% endif %}

        {# --- [NEW] 수동 순서 결과 표시 --- #}
        {% if manual_results %}
            <div class="card mt-4 border-secondary">
                <div class="card-header bg-secondary text-white"><strong>[수동 입력 결과] 요약</strong></div>
                <div class="card-body">
                    <p><strong>입력된 작업 순서:</strong>
                        {% for job_id in manual_results.sequence %}
                            <span class="badge badge-secondary" style="font-size: 1rem;">{{ job_id }}</span>{% if not forloop.last %} &rarr; {% endif %}
                        {% endfor %}
                    </p>
                    <p><strong>계산된 Makespan:</strong>
                        <span class="h4 {% if manual_results.makespan > results.makespan %}text-danger{% else %}text-success{% endif %}">
                            {{ manual_results.makespan}}
                        </span>
                        <small>(최적 Makespan: {{ results.makespan }})</small>
                    </p>
                </div>
            </div>

            {% if manual_plot_data %}
            <div class="card mt-3">
                <div class="card-header"><strong>[수동 입력 결과] 간트 차트</strong></div>
                <div class="card-body">
                    <div class="chart-container" style="...">
                        <canvas id="manualGanttChart"></canvas> {# 새 ID 부여 #}
                    </div>
                </div>
            </div>
            {% endif %}
        {% endif %} {# end if manual_results #}

        {# --- [NEW] 수동 순서 입력 및 비교 폼 --- #}
        <hr class="my-5">
        <div class="manual-check-section mt-4">
            <h3 class="mt-4">수동 순서 비교</h3>
            <p>최적화 결과와 비교하고 싶은 다른 작업 순서를 직접 입력해 보세요. (예: {{ results.sequence|join:", " }})</p>
            <form method="POST" id="manualCheckForm">
                {% csrf_token %}
                <input type="hidden" name="action" value="manual_check">
                <!-- 원본 데이터와 최적화 결과를 다음 요청으로 전달하기 위한 숨겨진 필드 -->
                <input type="hidden" name="num_jobs" value="{{ submitted_num_jobs }}">
                <input type="hidden" name="num_machines" value="{{ submitted_num_machines }}">
                <input type="hidden" name="original_input_json" value="{{ original_input_json }}">
                <input type="hidden" name="optimal_results_json" value="{{ optimal_results_json }}">
                {# 사용자가 수정한 폼 값을 그대로 전달하기 위해 form_data도 함께 #}
                {% for key, value in form_data.items %}
                     {% if key != 'action' and key != 'csrfmiddlewaretoken' %}
                        <input type="hidden" name="{{ key }}" value="{{ value }}">
                    {% endif %}
                {% endfor %}

                <div class="form-group">
                    <label for="manual_sequence"><strong>작업 순서 입력 (쉼표로 구분)</strong></label>
                    <input type="text" class="form-control" id="manual_sequence" name="manual_sequence"
                            value="{{ results.sequence|join:", " }}">
                </div>
                <button type="submit" class="btn btn-secondary mt-2">수동 스케줄 결과 조회</button>
            </form>
        </div>
    {% endif %} {# end if results #}
</div>
{% endblock %}

{% block scripts %}
<script>
    function submitSettingsForm() {
        console.log("Settings changed, submitting form with current values.");

        const settingsForm = document.getElementById('settingsForm');
        settingsForm.innerHTML = ''; // 중복 제출 방지를 위해 폼 비우기

        // 1. 드롭다운 메뉴의 현재 값들을 숨겨진 필드로 추가
        const numJobsSelect = document.getElementById('num_jobs_to_show');
        const numMachinesSelect = document.getElementById('num_machines_to_show');

        const hiddenNumJobs = document.createElement('input');
        hiddenNumJobs.type = 'hidden';
        hiddenNumJobs.name = 'num_jobs_to_show';
        hiddenNumJobs.value = numJobsSelect.value;
        settingsForm.appendChild(hiddenNumJobs);

        const hiddenNumMachines = document.createElement('input');
        hiddenNumMachines.type = 'hidden';
        hiddenNumMachines.name = 'num_machines_to_show';
        hiddenNumMachines.value = numMachinesSelect.value;
        settingsForm.appendChild(hiddenNumMachines);

        // 2. 현재 테이블의 모든 입력 값을 숨겨진 필드로 추가
        const numJobsInTable = {{ submitted_num_jobs }};
        const numMachinesInTable = {{ submitted_num_machines }};

        for (let i = 0; i < numJobsInTable; i++) {
            const idElement = document.getElementById(`job_${i}_id`);
            if(idElement) {
                let hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = `job_${i}_id`;
                hiddenInput.value = idElement.value;
                settingsForm.appendChild(hiddenInput);
            }
            for (let j = 0; j < numMachinesInTable; j++) {
                const timeElement = document.getElementById(`p_${i}_${j}`);
                if(timeElement) {
                    let hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = `p_${i}_${j}`;
                    hiddenInput.value = timeElement.value;
                    settingsForm.appendChild(hiddenInput);
                }
            }
        }

        // 3. GET 방식으로 폼 제출 (페이지 리로드)
        settingsForm.submit();
    }

    document.addEventListener('DOMContentLoaded', function() {
        // [NEW] 랜덤 버튼 이벤트 리스너 추가
        const randomizeBtn = document.getElementById('randomizeBtn');
        if (randomizeBtn) {
            randomizeBtn.addEventListener('click', function() {
                console.log("Randomize button clicked for Flow Shop.");

                function getRandomInt(min, max) {
                    return Math.floor(Math.random() * (max - min + 1)) + min;
                }

                const numJobs = parseInt(document.getElementById('num_jobs_to_show').value);
                const numMachines = parseInt(document.getElementById('num_machines_to_show').value);

                for (let i = 0; i < numJobs; i++) {
                    // ID는 그대로 두거나 필요시 `Job ${i+1}`로 설정
                    for (let j = 0; j < numMachines; j++) {
                        const timeInput = document.getElementById(`p_${i}_${j}`);
                        if(timeInput) timeInput.value = getRandomInt(5, 30);
                    }
                }
                console.log("Processing times populated with random data.");
            });
        }

        // 기존 최적화 차트 그리기
        const plotDataJson = '{{ plot_data|safe|default_if_none:"[]" }}';
        try {
            const plotData = JSON.parse(plotDataJson);
            if (plotData && plotData.length > 0) {
                const ctx = document.getElementById('flowShopGanttChart');
                if (ctx) {
                    // 간트 차트 데이터 구성
                    const machineLabels = plotData[0].tasks.map(t => t.machine);
                    const colors = ['rgba(255, 99, 132, 0.6)', 'rgba(54, 162, 235, 0.6)', 'rgba(255, 206, 86, 0.6)', 'rgba(75, 192, 192, 0.6)', 'rgba(153, 102, 255, 0.6)', 'rgba(255, 159, 64, 0.6)'];
                    const datasets = plotData.map((job, index) => {
                        return {
                            label: job.job_id,
                            data: job.tasks.map(task => [task.start, task.end]),
                            backgroundColor: colors[index % colors.length],
                            borderColor: colors[index % colors.length].replace('0.6', '1'),
                            borderWidth: 1,
                            borderSkipped: false
                        }
                    });

                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: machineLabels,
                            datasets: datasets
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    stacked: false, // 스택하지 않음
                                    beginAtZero: true,
                                    title: { display: true, text: 'Time' }
                                },
                                y: {
                                    stacked: true // Y축은 스택하여 작업들이 겹쳐 보이지 않게 함
                                }
                            },
                            plugins: {
                                legend: { position: 'top' },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const datasetLabel = context.dataset.label || '';
                                            const value = context.raw;
                                            return `${datasetLabel}: [${value[0]}, ${value[1]}] (Duration: ${value[1]-value[0]})`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }
        } catch(e) { console.error("Error creating Flow Shop Gantt chart:", e); }

        // [NEW] 수동 결과 차트 그리기
        const manualPlotDataJson = '{{ manual_plot_data|safe|default_if_none:"[]" }}';
        try {
            const manualPlotData = JSON.parse(manualPlotDataJson);
            if (manualPlotData && manualPlotData.length > 0) {
                const manualCtx = document.getElementById('manualGanttChart');
                if (manualCtx) {
                    // 간트 차트 데이터 구성
                    const machineLabels = manualPlotData[0].tasks.map(t => t.machine);
                    const colors = ['rgba(255, 99, 132, 0.6)', 'rgba(54, 162, 235, 0.6)', 'rgba(255, 206, 86, 0.6)', 'rgba(75, 192, 192, 0.6)', 'rgba(153, 102, 255, 0.6)', 'rgba(255, 159, 64, 0.6)'];
                    const datasets = manualPlotData.map((job, index) => {
                        return {
                            label: job.job_id,
                            data: job.tasks.map(task => [task.start, task.end]),
                            backgroundColor: colors[index % colors.length],
                            borderColor: colors[index % colors.length].replace('0.6', '1'),
                            borderWidth: 1,
                            borderSkipped: false
                        }
                    });
                    new Chart(manualCtx, {
                        type: 'bar',
                        data: {
                            labels: machineLabels,
                            datasets: datasets
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    stacked: false, // 스택하지 않음
                                    beginAtZero: true,
                                    title: { display: true, text: 'Time' }
                                },
                                y: {
                                    stacked: true // Y축은 스택하여 작업들이 겹쳐 보이지 않게 함
                                }
                            },
                            plugins: {
                                legend: { position: 'top' },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const datasetLabel = context.dataset.label || '';
                                            const value = context.raw;
                                            return `${datasetLabel}: [${value[0]}, ${value[1]}] (Duration: ${value[1]-value[0]})`;
                                        }
                                    }
                                }
                            }
                        }
                    });

                }
            }
        } catch(e) { console.error("Error creating Flow Shop Gantt chart:", e); }
    });
</script>
{% endblock %}