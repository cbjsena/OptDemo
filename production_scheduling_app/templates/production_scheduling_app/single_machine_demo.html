{% extends "core/base.html" %}
{% load static %}
{% load production_filters %}

{% block title %}Single Machine Scheduling Demo{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'core/css/instruction.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Single Machine Scheduling Demo</h1>
    </div>
    <p>여러 작업의 처리 시간과 납기일을 입력하고 최적화 목표를 선택하여, 최적의 작업 순서를 계산하고 간트 차트로 확인합니다.</p>

    {# --- 설정 변경을 위한 숨겨진 GET 폼 --- #}
    <form method="GET" id="settingsForm" style="display: none;"></form>

    {# --- 사용자에게 보여지는 컨트롤러 (폼 바깥에 위치) --- #}
    <div class="mb-3 form-inline">
        <div class="form-group mr-2">
            <label for="num_jobs_to_show" class="mr-2">작업 수 (2-10):</label>
            <select id="num_jobs_to_show" class="form-control form-control-sm" onchange="submitSettingsForm()">
                {% for i in num_jobs_options %}
                    <option value="{{ i }}" {% if i == submitted_num_jobs %}selected{% endif %}>{{ i }}개</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group mr-2">
            <label for="objective_choice_get" class="mr-2">최적화 목표:</label>
            <select id="objective_choice_get" class="form-control form-control-sm" onchange="submitSettingsForm()">
                {% for obj in objective_options %}
                    <option value="{{ obj.value }}" {% if obj.value == submitted_objective %}selected{% endif %}>{{ obj.name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <form method="POST" id="schedulingForm">
        {% csrf_token %}
        <input type="hidden" name="problem_type" value="single_machine" id="problem_type">
        <input type="hidden" name="num_jobs" value="{{ submitted_num_jobs }}">
        <input type="hidden" name="objective_choice" value="{{ submitted_objective  }}">

        <div class="form-section">
            <h4>작업 정보 입력</h4>
            <div class="table-responsive">
                <table class="table table-bordered text-center">
                    <thead class="thead-light">
                        <tr>
                            <th>작업 ID</th>
                            <th>처리 시간 (Processing Time)</th>
                            <th>납기일 (Due Date)</th>
                            <th>준비 시간 (Release Time)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for job in jobs_list %}
                        <tr>
                            <td><input type="text" class="form-control form-control-sm"
                                       id="job_{{ forloop.counter0 }}_id" name="job_{{ forloop.counter0 }}_id" value="{{ job.id }}"></td>
                            <td><input type="number" min="1" class="form-control form-control-sm"
                                       id="job_{{ forloop.counter0 }}_processing_time" name="job_{{ forloop.counter0 }}_processing_time" value="{{ job.processing_time }}" required></td>
                            <td><input type="number" min="0" class="form-control form-control-sm"
                                       id="job_{{ forloop.counter0 }}_due_date" name="job_{{ forloop.counter0 }}_due_date" value="{{ job.due_date }}" required></td>
                            <td><input type="number" min="0" class="form-control form-control-sm"
                                       id="job_{{ forloop.counter0 }}_release_time" name="job_{{ forloop.counter0 }}_release_time" value="{{ job.release_time|default_if_none:0 }}" required></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary btn-lg mt-3 mb-3">최적 스케줄 계산 실행</button>
    </form>

    {# 1. 결과 메세지 #}
    {% if success_save_message%}
        <div class="alert alert-success" role="alert">{{ success_save_message }}</div>
    {% endif %}
    {% if opt_results is not None or error_message or success_message %}
    <hr class="my-4">
    <h3 class="mt-4">Optimization Results ({{ form_data.problem_type }})</h3>
    {% endif %}
    {% if error_message %}
        <div class="alert alert-danger" role="alert"><strong>오류:</strong> {{ error_message }}</div>
    {% endif %}
    {% if success_message and not error_message %}
        <div class="alert alert-success" role="alert">{{ success_message }}</div>
    {% endif %}

    {# 2. 결과 요약 및 시각화 #}

    {% if results %}
        <div class="card mt-3">
            <div class="card-header"><strong>결과 요약</strong></div>
            <div class="card-body">
                 <p><strong>최적 스케줄 순서:</strong> 
                    {% for job in results.schedule %}
                        <span class="badge badge-primary" style="font-size: 1rem;">{{ job.id }}</span>{% if not forloop.last %} &rarr; {% endif %}
                    {% endfor %}
                 </p>
                 <p><strong>최적 목표값:</strong> {{ results.objective_value}}</p>
                 <p><small>처리 시간: {{ processing_time_seconds }} 초</small></p>
            </div>
        </div>
        {% if plot_data %}
            <div class="card mt-3">
                <div class="card-header"><strong>간트 차트 (Gantt Chart)</strong></div>
                <div class="card-body">
                    <div class="chart-container" style="height: {{ submitted_num_jobs|add:2|multiply_custom:40 }}px;">
                        <canvas id="ganttChart"></canvas>
                    </div>
                </div>
            </div>
        {% endif %}
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
function submitSettingsForm() {
    console.log("Settings changed, submitting form with current values.");

    const settingsForm = document.getElementById('settingsForm');
    settingsForm.innerHTML = ''; // 중복 제출 방지를 위해 폼 비우기

    // 1. 드롭다운 메뉴의 현재 값들을 숨겨진 필드로 추가
    const numJobsSelect = document.getElementById('num_jobs_to_show');
    const objectiveSelect = document.getElementById('objective_choice_get');

    const hiddenNumJobs = document.createElement('input');
    hiddenNumJobs.type = 'hidden';
    hiddenNumJobs.name = 'num_jobs_to_show';
    hiddenNumJobs.value = numJobsSelect.value;
    settingsForm.appendChild(hiddenNumJobs);

    const hiddenObjective = document.createElement('input');
    hiddenObjective.type = 'hidden';
    hiddenObjective.name = 'objective_choice';
    hiddenObjective.value = objectiveSelect.value;
    settingsForm.appendChild(hiddenObjective);

    // 2. 현재 테이블의 모든 입력 값을 숨겨진 필드로 추가
    const numJobsInTable = document.querySelectorAll('#schedulingForm tbody tr').length;
    const fields = ['id', 'processing_time', 'due_date', 'release_time'];

    for (let i = 0; i < numJobsInTable; i++) {
        fields.forEach(field => {
            const inputElement = document.getElementById(`job_${i}_${field}`);
            if (inputElement) {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = `job_${i}_${field}`;
                hiddenInput.value = inputElement.value;
                settingsForm.appendChild(hiddenInput);
            }
        });
    }

    // 3. GET 방식으로 폼 제출 (페이지 리로드)
    settingsForm.submit();
}

document.addEventListener('DOMContentLoaded', function() {
    const plotDataJson = '{{ plot_data|safe|default_if_none:"{}" }}';
    try {
        const plotData = JSON.parse(plotDataJson);
        if (plotData && plotData.jobs) {
            const ctx = document.getElementById('ganttChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: plotData.jobs.map(j => j.label),
                        datasets: [{
                            label: '작업 스케줄',
                            data: plotData.jobs.map(j => j.data),
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1,
                            borderSkipped: false, // 막대 양쪽 테두리 모두 표시
                        }]
                    },
                    options: {
                        indexAxis: 'y', // 축을 바꿔서 가로 막대 차트 (간트 차트 형태)로 만듦
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: { display: true, text: 'Time' }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const job = plotData.jobs[context.dataIndex];
                                        return `Start: ${job.data[0]}, End: ${job.data[1]}, Duration: ${job.data[1] - job.data[0]}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
    } catch(e) { console.error("Error creating Gantt chart:", e); }
});
</script>
{% endblock %}