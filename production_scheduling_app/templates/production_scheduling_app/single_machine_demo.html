{% extends "core/base.html" %}
{% load static %}
{% load production_filters %}

{% block title %}Single Machine Scheduling Demo{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'core/css/instruction.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Single Machine Scheduling Demo</h1>
    </div>
    <p>여러 작업의 처리 시간과 납기일을 입력하고 최적화 목표를 선택하여, 최적의 작업 순서를 계산하고 간트 차트로 확인합니다.</p>

    <form method="GET" class="mb-3 form-inline">
        <div class="form-group mr-2">
            <label for="num_jobs_to_show" class="mr-2">작업 수 (3-8):</label>
            <select name="num_jobs_to_show" id="num_jobs_to_show" class="form-control form-control-sm" onchange="this.form.submit()">
                {% for i in num_jobs_options %}
                    <option value="{{ i }}" {% if i == submitted_num_jobs %}selected{% endif %}>{{ i }}개</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group mr-2">
            <label for="objective_choice_get" class="mr-2">최적화 목표:</label>
            <select name="objective_choice" id="objective_choice_get" class="form-control form-control-sm" onchange="this.form.submit()">
                {% for obj in objective_options %}
                    <option value="{{ obj.value }}" {% if obj.value == form_data.objective_choice %}selected{% endif %}>{{ obj.name }}</option>
                {% endfor %}
            </select>
        </div>
        <noscript><button type="submit" class="btn btn-sm btn-secondary">설정 적용</button></noscript>
    </form>

    <form method="POST" id="schedulingForm">
        {% csrf_token %}
        <input type="hidden" name="problem_type" value="single_machine" id="problem_type">
        <input type="hidden" name="num_jobs" value="{{ submitted_num_jobs }}">
        <input type="hidden" name="objective_choice" value="{{ submitted_objective }}">

        <div class="form-section">
            <h4>작업 정보 입력</h4>
            <div class="table-responsive">
                <table class="table table-bordered text-center">
                    <thead class="thead-light">
                        <tr>
                            <th>작업 ID</th>
                            <th>처리 시간 (Processing Time)</th>
                            <th>납기일 (Due Date)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for job in jobs_list %}
                        <tr>
                            <td><input type="text" class="form-control form-control-sm"
                                       name="job_{{ forloop.counter0 }}_id" value="{{ job.id }}"></td>
                            <td><input type="number" min="1" class="form-control form-control-sm"
                                       name="job_{{ forloop.counter0 }}_processing_time" value="{{ job.processing_time }}" required></td>
                            <td><input type="number" min="0" class="form-control form-control-sm"
                                       name="job_{{ forloop.counter0 }}_due_date" value="{{ job.due_date }}" required></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary btn-lg mt-3 mb-3">최적 스케줄 계산 실행</button>
    </form>

    {% if results or error_message or success_message %}
        <hr class="my-4"><h3 class="mt-4">Optimization Results</h3>
        {# ... 메시지 표시 로직 ... #}
        {% if success_message and not error_message %}<div class="alert alert-success">{{ success_message }}</div>{% endif %}
        {% if error_message %}<div class="alert alert-danger">{{ error_message }}</div>{% endif %}
    {% endif %}

    {% if results %}
        <div class="card mt-3">
            <div class="card-header"><strong>결과 요약</strong></div>
            <div class="card-body">
                 <p><strong>최적 스케줄 순서:</strong> 
                    {% for job in results.schedule %}
                        <span class="badge badge-primary" style="font-size: 1rem;">{{ job.id }}</span>{% if not forloop.last %} &rarr; {% endif %}
                    {% endfor %}
                 </p>
                 <p><strong>최적 목표값:</strong> {{ results.objective_value|floatformat:2 }}</p>
                 <p><small>처리 시간: {{ processing_time_seconds }} 초</small></p>
            </div>
        </div>
        {% if plot_data %}
            <div class="card mt-3">
                <div class="card-header"><strong>간트 차트 (Gantt Chart)</strong></div>
                <div class="card-body">
                    <div class="chart-container" style="height: {{ submitted_num_jobs|add:2|multiply_custom:40 }}px;">
                        <canvas id="ganttChart"></canvas>
                    </div>
                </div>
            </div>
        {% endif %}
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const plotDataJson = '{{ plot_data|safe|default_if_none:"{}" }}';
    try {
        const plotData = JSON.parse(plotDataJson);
        if (plotData && plotData.jobs) {
            const ctx = document.getElementById('ganttChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: plotData.jobs.map(j => j.label),
                        datasets: [{
                            label: '작업 스케줄',
                            data: plotData.jobs.map(j => j.data),
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1,
                            borderSkipped: false, // 막대 양쪽 테두리 모두 표시
                        }]
                    },
                    options: {
                        indexAxis: 'y', // 축을 바꿔서 가로 막대 차트 (간트 차트 형태)로 만듦
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: { display: true, text: 'Time' }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const job = plotData.jobs[context.dataIndex];
                                        return `Start: ${job.data[0]}, End: ${job.data[1]}, Duration: ${job.data[1] - job.data[0]}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
    } catch(e) { console.error("Error creating Gantt chart:", e); }
});
</script>
{% endblock %}