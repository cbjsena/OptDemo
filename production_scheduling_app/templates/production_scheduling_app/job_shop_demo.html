{% extends "core/base.html" %}
{% load static %}
{% load production_filters %}

{% block title %}Job Shop Scheduling Demo{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="h2">Job Shop Scheduling Demo</h1>
    <p>각 작업의 공정 순서(기계, 처리 시간)를 입력하여, 전체 작업 완료 시간(Makespan)을 최소화하는 최적 스케줄을 계산하고 간트 차트로 확인합니다.</p>

    <form method="GET" class="mb-3 form-inline">
        <div class="form-group mr-2">
            <label for="num_jobs_to_show">작업 수 (2-5):</label>
            <select name="num_jobs_to_show" id="num_jobs_to_show" class="form-control form-control-sm" onchange="this.form.submit()">
                {% for i in num_jobs_options %}<option value="{{ i }}" {% if i == submitted_num_jobs %}selected{% endif %}>{{ i }}개</option>{% endfor %}
            </select>
        </div>
        <div class="form-group mr-2">
            <label for="num_machines_to_show">기계 수 (3-4):</label>
            <select name="num_machines_to_show" id="num_machines_to_show" class="form-control form-control-sm" onchange="this.form.submit()">
                {% for i in num_machines_options %}<option value="{{ i }}" {% if i == submitted_num_machines %}selected{% endif %}>{{ i }}대</option>{% endfor %}
            </select>
            (작업 수나 기계 수를 변경하면 작업 정보가 초기화 됩니다.)
        </div>
    </form>

    <form method="POST" id="schedulingForm">
        {% csrf_token %}
        <input type="hidden" name="problem_type" value="job_shop" id="problem_type">
        <input type="hidden" name="num_jobs" value="{{ submitted_num_jobs }}">
        <input type="hidden" name="num_machines" value="{{ submitted_num_machines }}">

        <div class="form-section">
            <h4>작업별 정보 입력</h4>
            <div class="table-responsive">
                <table class="table table-bordered text-center">
                    <thead class="thead-light">
                        <tr>
                            <th rowspan="2" class="align-middle">작업 ID</th>
                            <th colspan="{{ submitted_num_machines }}">기계별 처리 시간</th>
                            <th rowspan="2" class="align-middle">공정 순서 (Routing)</th>
                        </tr>
                        <tr>
                            {% for j in submitted_num_machines|get_range %}
                            <th>기계 {{ j|add:1 }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for job in jobs_list %}
                        <tr>
                            <td><input type="text" class="form-control form-control-sm" name="job_{{ forloop.counter0 }}_id" value="{{ job.id }}"></td>

                            {% for processing_time in job.processing_times %}
                            <td>
                                <input type="number" min="1" name="p_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}"
                                       class="form-control form-control-sm" value="{{ processing_time }}">
                            </td>
                            {% endfor %}

                            <td>
                                <select class="form-control form-control-sm" name="job_{{ forloop.counter0 }}_routing">
                                    {% for route_tuple in possible_routings %}
                                        {% with route_str=route_tuple|join:"-" %}
                                            <option value="{{ route_str }}" {% if job.selected_routing == route_str %}selected{% endif %}>
                                                {% for machine_idx in route_tuple %}
                                                    M{{ machine_idx|add:1 }}{% if not forloop.last %} &rarr; {% endif %}
                                                {% endfor %}
                                            </option>
                                        {% endwith %}
                                    {% endfor %}
                                </select>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <button type="submit" class="btn btn-primary btn-lg mt-3 mb-3">최적 스케줄 계산 실행</button>
    </form>

    {% if results or error_message or success_message %}
        <hr class="my-4"><h3 class="mt-4">Optimization Results</h3>
        {% if success_message and not error_message %}<div class="alert alert-success">{{ success_message }}</div>{% endif %}
        {% if error_message %}<div class="alert alert-danger">{{ error_message }}</div>{% endif %}
    {% endif %}

    {% if results %}
        <div class="card mt-3">
            <div class="card-header"><strong>결과 요약</strong></div>
            <div class="card-body">
                 <p><strong>최소 Makespan:</strong> {{ results.makespan|floatformat:2 }}</p>
                 <p><small>처리 시간: {{ processing_time_seconds }} 초</small></p>
            </div>
        </div>
        {% if plot_data %}
            <div class="card mt-3">
                <div class="card-header"><strong>간트 차트 (Gantt Chart)</strong></div>
                <div class="card-body">
                    <div class="chart-container" style="height: {{ submitted_num_machines|add:1|multiply_custom:60 }}px;">
                        <canvas id="jobShopGanttChart"></canvas>
                    </div>
                </div>
            </div>
        {% endif %}
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const plotDataJson = '{{ plot_data|safe|default_if_none:"[]" }}';
    try {
        const plotData = JSON.parse(plotDataJson);
        if (plotData && plotData.length > 0) {
            const ctx = document.getElementById('jobShopGanttChart');
            if (ctx) {
                // Flow Shop 차트와 동일한 로직 사용 가능
                const machineLabels = [];
                const numMachines = {{ submitted_num_machines }};
                for (let i = 1; i <= numMachines; i++) {
                    machineLabels.push(`Machine ${i}`);
                }

                const colors = ['rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)'];
                const datasets = plotData.map((job, index) => {
                    // 각 작업의 데이터를 기계별로 재구성
                    let jobDataOnMachines = new Array(numMachines).fill(null);
                    job.tasks.forEach(task => {
                        // "Machine 1" -> 0, "Machine 2" -> 1
                        const machineIndex = parseInt(task.machine.split(' ')[1]) - 1;
                        jobDataOnMachines[machineIndex] = [task.start, task.end];
                    });

                    return {
                        label: job.job_id,
                        data: jobDataOnMachines,
                        backgroundColor: colors[index % colors.length],
                        borderColor: colors[index % colors.length].replace('0.7', '1'),
                        borderWidth: 1,
                        borderSkipped: false
                    }
                });

                new Chart(ctx, {
                    type: 'bar',
                    data: { labels: machineLabels, datasets: datasets },
                    options: { /* ... (Flow Shop 차트와 동일한 옵션) ... */ }
                });
            }
        }
    } catch(e) { console.error("Error creating Job Shop Gantt chart:", e); }
});
</script>
{% endblock %}